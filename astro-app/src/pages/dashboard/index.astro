---
import '@/styles/global.css';
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import { DashboardRoot } from '@/components/react/providers/DashboardRoot';
import { DashboardPage } from '@/components/react/DashboardPage';

// Get user, session, profile from middleware locals
const user = (Astro.locals as any).user;
const session = (Astro.locals as any).session;
const profile = (Astro.locals as any).profile;

if (!user) {
  return Astro.redirect('/login');
}

// Redirect admin users to admin dashboard
if (user.role === 'admin') {
  return Astro.redirect('/admin');
}

// Redirect to onboarding if not completed
if (!user.onboarding_completed) {
  return Astro.redirect('/onboarding');
}

// Map user plan to type
const plan = (user.plan || 'starter') as 'starter' | 'pro' | 'premium';
---

<DashboardLayout title="Tableau de bord">
  <DashboardRoot client:only="react" user={user} session={session} profile={profile}>
    <DashboardPage 
      firstName={user.first_name || 'Restaurateur'}
      plan={plan}
      onboardingCompleted={user.onboarding_completed || false}
    />
  </DashboardRoot>
</DashboardLayout>
