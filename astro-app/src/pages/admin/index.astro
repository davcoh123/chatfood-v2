---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { createServerClient } from '@/lib/supabase';
import AdminDashboardPage from '@/components/react/admin/AdminDashboardPage';

const supabase = createServerClient(Astro.cookies);

let isAuthenticated = false;
let isAdmin = false;
let userId = '';

try {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    isAuthenticated = true;
    userId = user.id;
    
    // Check admin role
    const { data: role, error } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', user.id)
      .single();
    
    if (!error && role?.role === 'admin') {
      isAdmin = true;
    }
  }
} catch (e) {
  console.error('Admin auth error:', e);
}

if (!isAuthenticated) {
  return Astro.redirect('/login?redirect=/admin');
}

if (!isAdmin) {
  return Astro.redirect('/dashboard');
}
---

<AdminLayout title="Administration">
  <AdminDashboardPage client:only="react" />
</AdminLayout>
