import{d as q,r as l,s as x,ah as v,j as e,i as U,e as n,C as z,a as G,b as K,g as O,c as V,B as f,D as J,n as Q,o as W,p as X,q as Y,t as Z,I as $,M as ee}from"./index.js";import{u as se,T as ae,t as te}from"./support2.js";import{T as re,a as ie,b as k,c as r,d as ne,e as i}from"./table.js";import{S as le,a as ce,b as oe,c as de,d as c}from"./select.js";import{E as ue}from"./eye.js";import{S as me}from"./send.js";import{C as w}from"./circle-check.js";import{S as xe}from"./star.js";import{C as he}from"./circle-alert.js";import{C as D}from"./clock.js";import{f as pe,b as ge}from"./fr.js";import"./types.js";import"./index4.js";import"./index3.js";import"./index5.js";import"./check.js";function He(){const{user:b}=q(),[o,M]=l.useState([]),[B,N]=l.useState(!0),[a,h]=l.useState(null),[d,y]=l.useState(""),[u,H]=l.useState("all"),{messages:I,loading:R,sendMessage:A}=se(a==null?void 0:a.id);l.useEffect(()=>{p();const s=x.channel("admin-tickets").on("postgres_changes",{event:"*",schema:"public",table:"support_tickets"},()=>{p()}).subscribe();return()=>{x.removeChannel(s)}},[]);const p=async()=>{try{N(!0);const{data:s,error:t}=await x.from("support_tickets").select("*").order("last_message_at",{ascending:!1});if(t)throw t;M(s||[])}catch(s){console.error("Error fetching tickets:",s),v({title:"Erreur",description:"Impossible de charger les tickets",variant:"destructive"})}finally{N(!1)}},C=async()=>{if(!d.trim()||!a)return;await A(d,"admin")&&y("")},F=async()=>{if(!(!a||!b))try{const{error:s}=await x.from("support_tickets").update({status:"awaiting_review",awaiting_review:!0,resolved_by:b.id,updated_at:new Date().toISOString()}).eq("id",a.id);if(s)throw s;v({title:"Conversation fermÃ©e",description:"L'utilisateur va recevoir une demande d'Ã©valuation"}),h(null),p()}catch(s){console.error("Error closing conversation:",s),v({title:"Erreur",description:"Impossible de fermer la conversation",variant:"destructive"})}},_=(s,t)=>{if(t)return e.jsxs(n,{variant:"outline",className:"gap-1 border-yellow-500 text-yellow-600",children:[e.jsx(xe,{className:"h-3 w-3"}),"En attente d'Ã©valuation"]});const m={open:{variant:"default",icon:D,label:"Nouveau"},awaiting_admin:{variant:"destructive",icon:ee,label:"ðŸ”´ RÃ©ponse requise"},awaiting_user:{variant:"secondary",icon:D,label:"En attente user"},in_progress:{variant:"secondary",icon:he,label:"En cours"},resolved:{variant:"outline",icon:w,label:"RÃ©solu"},closed:{variant:"outline",icon:w,label:"FermÃ©"}},j=m[s]||m.open,P=j.icon;return e.jsxs(n,{variant:j.variant,className:"gap-1",children:[e.jsx(P,{className:"h-3 w-3"}),j.label]})},S=s=>s==="high"?e.jsx(n,{variant:"destructive",children:"Haute"}):s==="urgent"?e.jsx(n,{variant:"destructive",className:"animate-pulse",children:"Urgent"}):e.jsx(n,{variant:"secondary",children:"Normale"}),T=s=>{const t={starter:"bg-blue-500/10 text-blue-500 border-blue-500/20",pro:"bg-purple-500/10 text-purple-500 border-purple-500/20",premium:"bg-yellow-500/10 text-yellow-500 border-yellow-500/20"};return e.jsx(n,{variant:"outline",className:t[s]||"",children:s.toUpperCase()})},L=s=>{var t;return((t=te.find(m=>m.value===s))==null?void 0:t.label)||s},g=u==="all"?o:u==="awaiting_admin"?o.filter(s=>s.status==="awaiting_admin"||s.status==="open"):o.filter(s=>s.status===u),E=o.filter(s=>s.status==="awaiting_admin"||s.status==="open").length;return e.jsxs("div",{className:"container mx-auto py-8 px-4 space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-primary/10 p-3 rounded-lg",children:e.jsx(U,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Gestion des Tickets"}),e.jsx("p",{className:"text-muted-foreground",children:"Support client"})]}),E>0&&e.jsxs(n,{variant:"destructive",className:"ml-4",children:[E," en attente"]})]}),e.jsxs(le,{value:u,onValueChange:H,children:[e.jsx(ce,{className:"w-[220px]",children:e.jsx(oe,{})}),e.jsxs(de,{children:[e.jsx(c,{value:"all",children:"Tous les tickets"}),e.jsx(c,{value:"awaiting_admin",children:"ðŸ”´ RÃ©ponse requise"}),e.jsx(c,{value:"awaiting_user",children:"En attente user"}),e.jsx(c,{value:"resolved",children:"RÃ©solus"}),e.jsx(c,{value:"closed",children:"FermÃ©s"})]})]})]}),e.jsxs(z,{children:[e.jsxs(G,{children:[e.jsxs(K,{children:["Tickets de support (",g.length,")"]}),e.jsx(O,{children:"GÃ©rez les demandes de support des utilisateurs"})]}),e.jsx(V,{children:B?e.jsx("div",{className:"text-center py-8",children:"Chargement..."}):g.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Aucun ticket Ã  afficher"}):e.jsx("div",{className:"border rounded-lg",children:e.jsxs(re,{children:[e.jsx(ie,{children:e.jsxs(k,{children:[e.jsx(r,{children:"Utilisateur"}),e.jsx(r,{children:"Plan"}),e.jsx(r,{children:"Type"}),e.jsx(r,{children:"Sujet"}),e.jsx(r,{children:"PrioritÃ©"}),e.jsx(r,{children:"Statut"}),e.jsx(r,{children:"Dernier message"}),e.jsx(r,{className:"text-right",children:"Actions"})]})}),e.jsx(ne,{children:g.map(s=>e.jsxs(k,{className:s.status==="awaiting_admin"?"bg-destructive/5":"",children:[e.jsx(i,{className:"font-medium",children:s.user_email}),e.jsx(i,{children:T(s.user_plan)}),e.jsx(i,{children:e.jsx("span",{className:"text-sm",children:L(s.ticket_type)})}),e.jsx(i,{children:e.jsx("div",{className:"max-w-[200px] truncate",children:s.subject})}),e.jsx(i,{children:S(s.priority)}),e.jsx(i,{children:_(s.status,s.awaiting_review)}),e.jsx(i,{className:"text-sm text-muted-foreground",children:pe(new Date(s.last_message_at||s.created_at),"dd/MM/yy HH:mm",{locale:ge})}),e.jsx(i,{className:"text-right",children:e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>h(s),children:e.jsx(ue,{className:"h-4 w-4"})})})]},s.id))})]})})})]}),e.jsx(J,{open:!!a,onOpenChange:()=>h(null),children:e.jsxs(Q,{className:"max-w-3xl max-h-[90vh] flex flex-col",children:[e.jsxs(W,{children:[e.jsxs(X,{children:["Conversation - ",a==null?void 0:a.subject]}),e.jsxs(Y,{children:["Ticket #",a==null?void 0:a.id.slice(0,8)," â€¢ ",a==null?void 0:a.user_email]})]}),a&&e.jsxs("div",{className:"flex-1 flex flex-col gap-4 min-h-0",children:[e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[_(a.status,a.awaiting_review),S(a.priority),T(a.user_plan)]}),e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-1 text-sm",children:"Description initiale"}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:a.description})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-background",children:e.jsx(ae,{messages:I,loading:R})}),!a.awaiting_review&&a.status!=="resolved"&&e.jsxs(Z,{className:"flex-col sm:flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx($,{value:d,onChange:s=>y(s.target.value),placeholder:"RÃ©pondre Ã  l'utilisateur...",onKeyPress:s=>s.key==="Enter"&&!s.shiftKey&&C(),className:"flex-1"}),e.jsx(f,{onClick:C,disabled:!d.trim(),children:e.jsx(me,{className:"h-4 w-4"})})]}),e.jsxs(f,{onClick:F,variant:"outline",className:"w-full",children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Fermer la conversation (demander Ã©valuation)"]})]}),a.awaiting_review&&e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg text-center",children:e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"En attente de l'Ã©valuation de l'utilisateur"})})]})]})})]})}export{He as default};
