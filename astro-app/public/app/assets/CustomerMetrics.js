import{j as e,h as q,d as z,s as w,r as $,B as W,C as j,a as v,b,c as y,U as G,g as A}from"./index.js";import{T as I,a as H,b as M,c as D}from"./tabs.js";import{R as E,C as K,X as P,Y as B,T as Q,L as U,B as V,c as X,A as Y,a as J}from"./AreaChart.js";import{L as Z}from"./LineChart.js";import{b as S,c as ee}from"./useSatisfactionAnalytics.js";import{u as T}from"./useQuery.js";import{a as se}from"./useAnalyticsExport.js";import{F as te}from"./file-text.js";import{F as ae}from"./file-spreadsheet.js";import{H as re}from"./heart.js";import{S as ne}from"./star.js";import{C as ie}from"./clock.js";import"./index2.js";import"./index3.js";import"./isPlainObject.js";import"./endOfWeek.js";import"./fr.js";const oe=({retentionData:s,isLoading:o=!1})=>o?e.jsx(q,{className:"h-[400px] w-full"}):s.length===0?e.jsx("div",{className:"flex items-center justify-center h-[400px] text-muted-foreground",children:"Aucune donnée de rétention disponible"}):e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(Z,{data:s,children:[e.jsx(K,{strokeDasharray:"3 3",className:"opacity-30"}),e.jsx(P,{dataKey:"month",tick:{fill:"hsl(var(--muted-foreground))"}}),e.jsx(B,{tick:{fill:"hsl(var(--muted-foreground))"},tickFormatter:n=>`${n}%`}),e.jsx(Q,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))",borderRadius:"8px"},formatter:(n,l)=>[l==="retention"?`${n}%`:n,l==="retention"?"Rétention":l==="newCustomers"?"Nouveaux clients":"Clients récurrents"]}),e.jsx(U,{type:"monotone",dataKey:"retention",stroke:"hsl(var(--primary))",strokeWidth:3,isAnimationActive:!0})]})})}),de=({satisfactionData:s,isLoading:o=!1})=>o?e.jsx(q,{className:"h-[400px] w-full"}):s.length===0?e.jsx("div",{className:"flex items-center justify-center h-[400px] text-muted-foreground",children:"Aucune donnée de satisfaction disponible"}):e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(V,{data:s,children:[e.jsx(K,{strokeDasharray:"3 3",className:"opacity-30"}),e.jsx(P,{dataKey:"rating",tick:{fill:"hsl(var(--muted-foreground))"}}),e.jsx(B,{tick:{fill:"hsl(var(--muted-foreground))"}}),e.jsx(Q,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))",borderRadius:"8px"},formatter:(n,l)=>[l==="count"?`${n} avis`:`${n}%`,l==="count"?"Nombre d'avis":"Pourcentage"]}),e.jsx(X,{dataKey:"count",fill:"hsl(var(--primary))",radius:[4,4,0,0],isAnimationActive:!0})]})})}),ce=({data:s=[],isLoading:o=!1})=>o?e.jsx(q,{className:"h-[400px] w-full"}):s.length===0?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"Pas de données de conversion disponibles"}):e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(Y,{data:s,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"conversionGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"hsl(var(--primary))",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"hsl(var(--primary))",stopOpacity:0})]})}),e.jsx(K,{strokeDasharray:"3 3",className:"opacity-30"}),e.jsx(P,{dataKey:"timeRange",tick:{fill:"hsl(var(--muted-foreground))"}}),e.jsx(B,{tick:{fill:"hsl(var(--muted-foreground))"}}),e.jsx(Q,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))",borderRadius:"8px"},formatter:n=>[`${n} clients`,"Clients"]}),e.jsx(J,{type:"monotone",dataKey:"customers",stroke:"hsl(var(--primary))",fill:"url(#conversionGradient)",isAnimationActive:!0})]})})}),_=5*60*1e3,L=30*60*1e3;function le(){const{user:s}=z(),o=T({queryKey:["analytics-data-orders",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:t}=await w.from("chatbot_orders").select("id, heure_de_commande, status, price_total, commande_item, phone").eq("user_id",s.id).order("heure_de_commande",{ascending:!1});if(t)throw t;return i||[]},enabled:!!(s!=null&&s.id),staleTime:_,gcTime:L,refetchOnWindowFocus:!1}),n=T({queryKey:["analytics-data-delivered-orders",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:t}=await w.from("chatbot_orders").select("id, heure_de_commande, status, price_total, commande_item, phone").eq("user_id",s.id).eq("status","delivered").order("heure_de_commande",{ascending:!1});if(t)throw t;return i||[]},enabled:!!(s!=null&&s.id),staleTime:_,gcTime:L,refetchOnWindowFocus:!1}),l=T({queryKey:["analytics-data-messages",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:t}=await w.from("chatbot_messages").select("id, from_number, to_number, created_at, body, message_type, status").eq("user_id",s.id).order("created_at",{ascending:!0});if(t)throw t;return i||[]},enabled:!!(s!=null&&s.id),staleTime:_,gcTime:L,refetchOnWindowFocus:!1}),N=T({queryKey:["analytics-data-products",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:t}=await w.from("products").select("id, name, category, unit_price").eq("user_id",s.id);if(t)throw t;return i||[]},enabled:!!(s!=null&&s.id),staleTime:_,gcTime:L,refetchOnWindowFocus:!1}),h=T({queryKey:["analytics-data-customers",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:t}=await w.from("customers").select("id, phone, name, total_orders, total_spent, first_interaction_at, last_interaction_at").eq("user_id",s.id);if(t)throw t;return i||[]},enabled:!!(s!=null&&s.id),staleTime:_,gcTime:L,refetchOnWindowFocus:!1}),x=T({queryKey:["analytics-data-reviews",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:t}=await w.from("order_reviews").select("id, rating, comment, created_at").eq("user_id",s.id).order("created_at",{ascending:!1});if(t)throw t;return i||[]},enabled:!!(s!=null&&s.id),staleTime:_,gcTime:L,refetchOnWindowFocus:!1}),f=o.isLoading||n.isLoading||l.isLoading||N.isLoading||h.isLoading||x.isLoading;return{orders:o.data||[],deliveredOrders:n.data||[],messages:l.data||[],products:N.data||[],customers:h.data||[],reviews:x.data||[],isLoading:f,ordersLoading:o.isLoading,messagesLoading:l.isLoading,productsLoading:N.isLoading,customersLoading:h.isLoading,reviewsLoading:x.isLoading}}function me(){const{orders:s,messages:o,isLoading:n}=le();return{...$.useMemo(()=>{if(!o.length||!s.length)return{conversionTimeData:[],metrics:{averageConversionTime:0,fastestConversion:0,slowestConversion:0,medianConversionTime:0,totalConversions:0,conversionRate:0}};const N=o.filter(a=>a.status==="receive"||a.status==="received"||a.status===null),h={};N.forEach(a=>{const r=a.from_number;if(!r)return;const u=new Date(a.created_at);(!h[r]||u<h[r])&&(h[r]=u)});const x={};s.forEach(a=>{const r=a.phone;if(!r)return;const u=new Date(a.heure_de_commande);(!x[r]||u<x[r])&&(x[r]=u)});const f=[],i=new Set(Object.keys(h)),t=new Set(Object.keys(x));Object.entries(h).forEach(([a,r])=>{const u=x[a];if(u&&u>=r){const F=(u.getTime()-r.getTime())/(1e3*60);F>=0&&F<=24*60&&f.push(F)}});const g=[...f].sort((a,r)=>a-r),p=f.length,R=p>0?Math.round(f.reduce((a,r)=>a+r,0)/p*10)/10:0,O=g[0]||0,k=g[g.length-1]||0,d=p>0?g[Math.floor(g.length/2)]:0,c=i.size>0?Math.round(t.size/i.size*100):0;return{conversionTimeData:[{label:"< 5 min",min:0,max:5},{label:"5-15 min",min:5,max:15},{label:"15-30 min",min:15,max:30},{label:"30-60 min",min:30,max:60},{label:"1h+",min:60,max:1/0}].map(a=>{const r=f.filter(u=>u>=a.min&&u<a.max).length;return{timeRange:a.label,customers:r,percentage:p>0?Math.round(r/p*100):0}}),metrics:{averageConversionTime:R,fastestConversion:Math.round(O*10)/10,slowestConversion:Math.round(k*10)/10,medianConversionTime:Math.round(d*10)/10,totalConversions:p,conversionRate:c}}},[s,o]),isLoading:n}}const qe=()=>{const{retentionRate:s,loyalCustomers:o,segments:n,retentionData:l,isLoading:N}=S(),{averageRating:h,ratingChange:x,ratingsDistribution:f,isLoading:i}=ee(),{conversionTimeData:t,metrics:g,isLoading:p}=me(),{exportPDF:R,exportExcel:O,isExporting:k}=se(),d=n.find(C=>C.type==="vip"),c=n.find(C=>C.type==="regular"),m=n.find(C=>C.type==="new");return e.jsxs("div",{className:"p-6 space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 animate-fade-in",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Métriques Client"}),e.jsx("p",{className:"text-muted-foreground",children:"Analysez le comportement et la satisfaction de vos clients"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(W,{variant:"outline",size:"sm",onClick:R,disabled:k,children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Export PDF"]}),e.jsxs(W,{variant:"outline",size:"sm",onClick:O,disabled:k,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Export Excel"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 animate-slide-up",children:[e.jsxs(j,{className:"border-primary/10 bg-gradient-to-br from-purple-500/5 to-purple-500/10",children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Taux de rétention"}),e.jsx(re,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(y,{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[s,"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Clients récurrents"})]})]}),e.jsxs(j,{className:"border-primary/10 bg-gradient-to-br from-orange-500/5 to-orange-500/10",children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Satisfaction moyenne"}),e.jsx(ne,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(y,{children:[e.jsxs("div",{className:"text-2xl font-bold text-orange-600",children:[h,"/5"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x>=0?"+":"",x," vs mois dernier"]})]})]}),e.jsxs(j,{className:"border-primary/10 bg-gradient-to-br from-blue-500/5 to-blue-500/10",children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Temps conversion"}),e.jsx(ie,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(y,{children:[p?e.jsx(q,{className:"h-8 w-20"}):e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:g.averageConversionTime>0?`~${Math.round(g.averageConversionTime)}min`:"N/A"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Premier message → commande"})]})]}),e.jsxs(j,{className:"border-primary/10 bg-gradient-to-br from-green-500/5 to-green-500/10",children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Clients fidèles"}),e.jsx(G,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(y,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:o}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"3+ commandes"})]})]})]}),e.jsxs(I,{defaultValue:"retention",className:"animate-slide-up animation-delay-200",children:[e.jsxs(H,{className:"grid w-full grid-cols-3",children:[e.jsx(M,{value:"retention",children:"Rétention Client"}),e.jsx(M,{value:"satisfaction",children:"Satisfaction"}),e.jsx(M,{value:"conversion",children:"Temps de Conversion"})]}),e.jsx(D,{value:"retention",className:"space-y-4 animate-tab-content",children:e.jsxs(j,{children:[e.jsxs(v,{children:[e.jsx(b,{children:"Taux de Rétention Client"}),e.jsx(A,{children:"Évolution de la fidélité de vos clients"})]}),e.jsx(y,{children:e.jsx(oe,{retentionData:l,isLoading:N})})]})}),e.jsx(D,{value:"satisfaction",className:"space-y-4 animate-tab-content",children:e.jsxs(j,{children:[e.jsxs(v,{children:[e.jsx(b,{children:"Taux de Satisfaction Client"}),e.jsx(A,{children:"Distribution des notes de satisfaction"})]}),e.jsx(y,{children:e.jsx(de,{satisfactionData:f,isLoading:i})})]})}),e.jsx(D,{value:"conversion",className:"space-y-4 animate-tab-content",children:e.jsxs(j,{children:[e.jsxs(v,{children:[e.jsx(b,{children:"Temps de Conversion"}),e.jsx(A,{children:"Temps entre premier message et commande"})]}),e.jsx(y,{children:e.jsx(ce,{data:t,isLoading:p})})]})})]}),e.jsxs(j,{className:"animate-slide-up animation-delay-300",children:[e.jsxs(v,{children:[e.jsx(b,{children:"Segments Clients"}),e.jsx(A,{children:"Classification par comportement d'achat"})]}),e.jsx(y,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"p-6 rounded-lg border bg-gradient-to-br from-green-500/5 to-green-500/10 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-green-700 dark:text-green-300",children:"Clients VIP"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:(d==null?void 0:d.count)||0}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["10+ commandes, dépense moy: €",(d==null?void 0:d.averageSpend)||0]}),e.jsxs("p",{className:"text-xs text-green-600",children:[(d==null?void 0:d.percentageOfCustomers)||0,"% clients, ",(d==null?void 0:d.percentageOfRevenue)||0,"% CA"]})]})]})}),e.jsx("div",{className:"p-6 rounded-lg border bg-gradient-to-br from-blue-500/5 to-blue-500/10 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-blue-700 dark:text-blue-300",children:"Clients Réguliers"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:(c==null?void 0:c.count)||0}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["3-9 commandes, dépense moy: €",(c==null?void 0:c.averageSpend)||0]}),e.jsxs("p",{className:"text-xs text-blue-600",children:[(c==null?void 0:c.percentageOfCustomers)||0,"% clients, ",(c==null?void 0:c.percentageOfRevenue)||0,"% CA"]})]})]})}),e.jsx("div",{className:"p-6 rounded-lg border bg-gradient-to-br from-orange-500/5 to-orange-500/10 border-orange-200 dark:border-orange-800",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-orange-700 dark:text-orange-300",children:"Nouveaux Clients"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:(m==null?void 0:m.count)||0}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["1-2 commandes, dépense moy: €",(m==null?void 0:m.averageSpend)||0]}),e.jsxs("p",{className:"text-xs text-orange-600",children:[(m==null?void 0:m.percentageOfCustomers)||0,"% clients, ",(m==null?void 0:m.percentageOfRevenue)||0,"% CA"]})]})]})})]})})]})]})};export{qe as default};
