import{d as A,r as m,s as x,m as o,b2 as L,j as e,bl as F,C as j,a as S,ao as b,b as k,g as E,c as N,B as v,e as p}from"./index.js";import{S as T}from"./switch.js";import{L as B}from"./label.js";import{A as z,b as O,a as P}from"./alert.js";import{L as _}from"./loader-circle.js";import{E as D}from"./external-link.js";import{C as y}from"./circle-alert.js";import{C as V}from"./clock.js";import{C as q}from"./circle-check-big.js";import"./index5.js";function I(){const{user:i}=A(),[s,u]=m.useState(null),[l,d]=m.useState(!0),[f,h]=m.useState(!1),c=m.useCallback(async()=>{var n;if(!i){d(!1);return}try{const{data:r}=await x.auth.getSession();if(!((n=r==null?void 0:r.session)!=null&&n.access_token)){d(!1);return}const a=await fetch("https://dcwfgxbwpecnjbhrhrib.supabase.co/functions/v1/stripe-account-status",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.session.access_token}`}}),t=await a.json();a.ok&&t.success?u({connected:t.connected,account_id:t.account_id,onboarding_status:t.onboarding_status,charges_enabled:t.charges_enabled||!1,payouts_enabled:t.payouts_enabled||!1,details_submitted:t.details_submitted,payments_enabled:t.payments_enabled||!1,platform_fee_percent:t.platform_fee_percent||5,requirements:t.requirements}):console.error("Error fetching Stripe status:",t.error)}catch(r){console.error("Error fetching Stripe status:",r)}finally{d(!1)}},[i]);return m.useEffect(()=>{c()},[c]),{status:s,isLoading:l,isConnecting:f,startOnboarding:async()=>{var n;if(i){h(!0);try{const{data:r}=await x.auth.getSession();if(!((n=r==null?void 0:r.session)!=null&&n.access_token)){o.error("Session expirée, veuillez vous reconnecter");return}const a=await fetch("https://dcwfgxbwpecnjbhrhrib.supabase.co/functions/v1/stripe-create-account",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.session.access_token}`},body:JSON.stringify({base_url:window.location.origin})}),t=await a.json();a.ok&&t.success&&t.onboarding_url?window.location.href=t.onboarding_url:o.error(t.error||"Erreur lors de la connexion Stripe")}catch(r){console.error("Error starting Stripe onboarding:",r),o.error("Erreur lors de la connexion Stripe")}finally{h(!1)}}},openDashboard:async()=>{var n;if(!(!i||!(s!=null&&s.connected)))try{const{data:r}=await x.auth.getSession();if(!((n=r==null?void 0:r.session)!=null&&n.access_token)){o.error("Session expirée, veuillez vous reconnecter");return}const a=await fetch("https://dcwfgxbwpecnjbhrhrib.supabase.co/functions/v1/stripe-dashboard-link",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.session.access_token}`}}),t=await a.json();a.ok&&t.success&&t.dashboard_url?window.open(t.dashboard_url,"_blank"):o.error(t.error||"Erreur lors de l'ouverture du dashboard")}catch(r){console.error("Error opening Stripe dashboard:",r),o.error("Erreur lors de l'ouverture du dashboard")}},togglePayments:async n=>{if(i)try{const{error:r}=await x.from("restaurant_settings").update({payments_enabled:n}).eq("user_id",i.id);if(r)throw r;u(a=>a?{...a,payments_enabled:n}:null),o.success(n?"Paiements en ligne activés":"Paiements en ligne désactivés")}catch(r){console.error("Error toggling payments:",r),o.error("Erreur lors de la mise à jour")}},refetch:c}}function X(){const[i]=L(),{status:s,isLoading:u,isConnecting:l,startOnboarding:d,openDashboard:f,togglePayments:h,refetch:c}=I();m.useEffect(()=>{const n=i.get("success"),r=i.get("refresh");n==="true"?(o.success("Connexion Stripe réussie !"),c()):r==="true"&&(o.info("Veuillez finaliser votre inscription Stripe"),c())},[i,c]);const w=()=>{if(!(s!=null&&s.connected))return e.jsx(p,{variant:"secondary",children:"Non connecté"});switch(s.onboarding_status){case"complete":return e.jsx(p,{className:"bg-green-500 text-white",children:"Actif"});case"pending_verification":return e.jsx(p,{className:"bg-yellow-500 text-white",children:"En vérification"});case"pending":return e.jsx(p,{className:"bg-orange-500 text-white",children:"Onboarding incomplet"});default:return e.jsx(p,{variant:"secondary",children:"Non configuré"})}},C=()=>{if(!(s!=null&&s.connected))return e.jsx(y,{className:"h-5 w-5 text-muted-foreground"});switch(s.onboarding_status){case"complete":return e.jsx(q,{className:"h-5 w-5 text-green-500"});case"pending_verification":return e.jsx(V,{className:"h-5 w-5 text-yellow-500"});default:return e.jsx(y,{className:"h-5 w-5 text-orange-500"})}};if(u)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(_,{className:"h-8 w-8 animate-spin text-muted-foreground"})});const g=(s==null?void 0:s.connected)&&(s==null?void 0:s.charges_enabled);return e.jsxs(e.Fragment,{children:[e.jsx(F,{children:e.jsx("title",{children:"Paiements | ChatFood"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Paiements en ligne"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Configurez Stripe pour accepter les paiements par carte bancaire"})]}),e.jsxs(j,{children:[e.jsx(S,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(b,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx(k,{className:"text-lg",children:"Compte Stripe"}),e.jsx(E,{children:"Connectez votre compte Stripe Express pour recevoir les paiements"})]})]}),w()]})}),e.jsx(N,{className:"space-y-4",children:s!=null&&s.connected?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-muted rounded-lg",children:[C(),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.onboarding_status==="complete"?"Votre compte Stripe est prêt":s.onboarding_status==="pending_verification"?"Vérification en cours":"Finalisez votre inscription"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.charges_enabled?"Vous pouvez accepter les paiements":"Complétez votre profil pour accepter les paiements"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[s.onboarding_status!=="complete"&&e.jsxs(v,{onClick:d,disabled:l,children:[l?e.jsx(_,{className:"h-4 w-4 mr-2 animate-spin"}):null,"Continuer l'inscription"]}),s.charges_enabled&&e.jsxs(v,{variant:"outline",onClick:f,children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),"Tableau de bord Stripe"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(z,{children:[e.jsx(b,{className:"h-4 w-4"}),e.jsx(O,{children:"Commencez à accepter les paiements"}),e.jsxs(P,{children:["Connectez votre compte Stripe pour recevoir les paiements directement sur votre compte bancaire. La commission plateforme est de ",(s==null?void 0:s.platform_fee_percent)||5,"%."]})]}),e.jsx(v,{onClick:d,disabled:l,children:l?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-4 w-4 mr-2 animate-spin"}),"Connexion en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-4 w-4 mr-2"}),"Connecter Stripe"]})})]})})]}),(s==null?void 0:s.connected)&&e.jsxs(j,{children:[e.jsxs(S,{children:[e.jsx(k,{className:"text-lg",children:"Activer les paiements"}),e.jsx(E,{children:"Activez les paiements en ligne sur votre profil public"})]}),e.jsxs(N,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(B,{htmlFor:"payments-toggle",children:"Paiements en ligne"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Les clients pourront payer par carte lors de leur commande"})]}),e.jsx(T,{id:"payments-toggle",checked:s.payments_enabled,onCheckedChange:h,disabled:!g})]}),!g&&s.connected&&e.jsxs(z,{className:"mt-4",variant:"destructive",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsx(P,{children:"Finalisez votre inscription Stripe pour activer les paiements."})]})]})]}),e.jsx(j,{className:"bg-muted/50",children:e.jsx(N,{className:"pt-6",children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsx("h4",{className:"font-medium",children:"Comment ça fonctionne ?"}),e.jsxs("ul",{className:"space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"1."}),"Connectez votre compte Stripe (création gratuite)"]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"2."}),"Activez les paiements sur votre profil public"]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"3."}),"Les clients paient par carte lors de leur commande"]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"4."}),"Les fonds sont transférés sur votre compte sous 2-7 jours"]})]}),e.jsxs("p",{className:"text-muted-foreground pt-2",children:["Commission plateforme : ",e.jsxs("strong",{children:[(s==null?void 0:s.platform_fee_percent)||5,"%"]})," par transaction",e.jsx("br",{}),"+ Frais Stripe standards (1.4% + 0.25€ par transaction en Europe)"]})]})})})]})]})}export{X as default};
