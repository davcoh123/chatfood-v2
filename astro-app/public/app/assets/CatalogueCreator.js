import{r as y,j as e,v as q,I as b,e as K,X as G,d as L,l as O,m as _,s as Q,u as H,D as M,n as W,o as X,p as J,P as Y,q as Z,B as g,A as D}from"./index.js";import{T as ee}from"./textarea.js";import{S as se}from"./switch.js";import{S as ae}from"./scroll-area.js";import{a as te}from"./useRestaurantSettings.js";import{T as I}from"./trash-2.js";import{P as S}from"./plus.js";import{A as re}from"./arrow-left.js";import{C as ne}from"./check.js";function k({value:u,onChange:j,placeholder:v="Ajouter un ingr√©dient...",className:i}){const[x,c]=y.useState(""),h=a=>{(a.key==="Enter"||a.key===",")&&(a.preventDefault(),r())},r=()=>{const a=x.trim();a&&!u.includes(a)&&(j([...u,a]),c(""))},d=a=>{const o=a.clipboardData.getData("text");if(o.includes(",")||o.includes(";")||o.includes(`
`)){a.preventDefault();const l=o.split(/[,;\n]+/).map(f=>f.replace(/^["']|["']$/g,"").trim()).filter(f=>f.length>0&&!u.includes(f));l.length>0&&(j([...u,...l]),c(""))}},N=a=>{j(u.filter(o=>o!==a))};return e.jsxs("div",{className:q("space-y-2",i),children:[e.jsx(b,{value:x,onChange:a=>c(a.target.value),onKeyDown:h,onPaste:d,onBlur:r,placeholder:v}),u.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:u.map((a,o)=>{const l=a.replace(/^["']|["']$/g,"").trim();return e.jsxs(K,{variant:"secondary",className:"gap-1 pr-1",children:[l,e.jsx("button",{type:"button",onClick:()=>N(a),className:"ml-1 rounded-full hover:bg-muted-foreground/20 p-0.5",children:e.jsx(G,{className:"h-3 w-3"})})]},o)})}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Appuyez sur ",e.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-xs",children:"Entr√©e"})," ou ",e.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-xs",children:","})," pour ajouter un ingr√©dient"]})]})}function ie(u){const[j,v]=y.useState([]),{profile:i}=L(),x=O(),c=u??(i==null?void 0:i.user_id),h=te({mutationFn:async r=>{if(!c)throw new Error("Utilisateur non identifi√©");const d=[];let N=0;for(const o of r)for(const l of o.products)d.push({user_id:c,name:l.name,ingredient:l.ingredient,category:o.name,description:l.description,unit_price:l.unit_price,currency:l.currency||"EUR",vat_rate:l.vat_rate||10,is_active:l.is_active!==!1,tags:l.tags||[],allergens:l.allergens||[],sort_order:N++});if(d.length===0)throw new Error("Aucun produit √† cr√©er");const{error:a}=await Q.from("products").insert(d);if(a)throw console.error("Error inserting products:",a),a;return{items:d,count:d.length}},onSuccess:r=>{_.success(`Catalogue cr√©√© avec succ√®s ! ${r.count} produits ajout√©s.`),v([]),x.invalidateQueries({queryKey:["catalogue-items"]})},onError:r=>{console.error("Erreur cr√©ation catalogue:",r),_.error("Erreur lors de la cr√©ation du catalogue.")}});return{categories:j,setCategories:v,createCatalogue:h.mutate,isCreating:h.isPending,hasWebhook:!!c}}function pe({open:u,onOpenChange:j,userId:v}){const[i,x]=y.useState(1),[c,h]=y.useState(0),{categories:r,setCategories:d,createCatalogue:N,isCreating:a}=ie(v),o=H(),l=()=>{x(1),h(0),d([]),j(!1)},f=()=>{d([...r,{id:crypto.randomUUID(),name:"",products:[]}])},E=s=>{d(r.filter(n=>n.id!==s))},P=(s,n)=>{d(r.map(t=>t.id===s?{...t,name:n}:t))},m=r[c],T=()=>{if(!m)return;const s={id:crypto.randomUUID(),name:"",ingredient:[],description:"",unit_price:0,currency:"EUR",vat_rate:10,is_active:!0,tags:[],allergens:[]};d(r.map((n,t)=>t===c?{...n,products:[...n.products,s]}:n))},z=s=>{m&&d(r.map((n,t)=>t===c?{...n,products:n.products.filter(C=>C.id!==s)}:n))},p=(s,n,t)=>{m&&d(r.map((C,$)=>$===c?{...C,products:C.products.map(w=>w.id===s?{...w,[n]:t}:w)}:C))},R=r.length>0&&r.every(s=>s.name.trim()),U=m&&m.products.length>0,A=c===r.length-1,V=()=>{A?x(3):h(c+1)},F=async()=>{N(r,{onSuccess:()=>{l(),o("/catalogue")}})},B=r.reduce((s,n)=>s+n.products.length,0);return e.jsx(M,{open:u,onOpenChange:l,children:e.jsxs(W,{className:"sm:max-w-2xl max-h-[90vh]",children:[e.jsxs(X,{children:[e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5 text-primary"}),"Cr√©er mon catalogue - √âtape ",i,"/3"]}),e.jsxs(Z,{children:[i===1&&"D√©finissez vos cat√©gories de produits",i===2&&`Ajoutez les produits pour : ${(m==null?void 0:m.name)||""}`,i===3&&"V√©rifiez et validez votre catalogue"]})]}),e.jsxs(ae,{className:"max-h-[60vh] pr-4",children:[i===1&&e.jsxs("div",{className:"space-y-4",children:[r.map(s=>e.jsx("div",{className:"p-4 border rounded-lg space-y-3 bg-card",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium",children:"Nom de la cat√©gorie"}),e.jsx(b,{value:s.name,onChange:n=>P(s.id,n.target.value),placeholder:"Ex: Entr√©es & Salades",className:"mt-1"})]}),e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>E(s.id),className:"text-destructive hover:text-destructive mt-6",children:e.jsx(I,{className:"h-4 w-4"})})]})},s.id)),e.jsxs(g,{onClick:f,variant:"outline",className:"w-full",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Ajouter une cat√©gorie"]})]}),i===2&&m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-muted rounded-lg",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Cat√©gorie : ",m.name]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[m.products.length," produit(s) ajout√©(s)"]})]}),m.products.map((s,n)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-3 bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Produit #",n+1]}),e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>z(s.id),className:"text-destructive hover:text-destructive h-8 w-8",children:e.jsx(I,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nom"}),e.jsx(b,{value:s.name,onChange:t=>p(s.id,"name",t.target.value),placeholder:"Ex: Soupe miso",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Ingr√©dients"}),e.jsx(k,{value:s.ingredient,onChange:t=>p(s.id,"ingredient",t),placeholder:"Ajouter des ingr√©dients...",className:"mt-1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(ee,{value:s.description,onChange:t=>p(s.id,"description",t.target.value),placeholder:"Description du produit",className:"mt-1",rows:2})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Prix (‚Ç¨)"}),e.jsx(b,{type:"number",step:"0.01",value:s.unit_price,onChange:t=>p(s.id,"unit_price",parseFloat(t.target.value)||0),placeholder:"0.00",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"TVA (%)"}),e.jsx(b,{value:s.vat_rate,onChange:t=>p(s.id,"vat_rate",parseFloat(t.target.value)||0),className:"mt-1"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"flex items-center gap-2 pb-2",children:[e.jsx(se,{checked:s.is_active===!0,onCheckedChange:t=>p(s.id,"is_active",t)}),e.jsx("label",{className:"text-sm font-medium",children:"Actif"})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Tags"}),e.jsx(k,{value:s.tags,onChange:t=>p(s.id,"tags",t),placeholder:"Ajouter des tags...",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Allerg√®nes"}),e.jsx(k,{value:s.allergens,onChange:t=>p(s.id,"allergens",t),placeholder:"Ajouter des allerg√®nes...",className:"mt-1"})]})]})]},s.id)),e.jsxs(g,{onClick:T,variant:"outline",className:"w-full",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Ajouter un produit"]})]}),i===3&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-primary/5 border border-primary/20 rounded-lg",children:[e.jsx("p",{className:"font-semibold text-lg mb-2",children:"üìä R√©capitulatif"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:["‚úì ",r.length," cat√©gorie(s) cr√©√©e(s)"]}),e.jsxs("p",{children:["‚úì ",B," produit(s) ajout√©(s)"]})]})]}),r.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card",children:[e.jsxs("p",{className:"font-medium mb-2",children:[s.name," (",s.products.length," produits)"]}),e.jsx("div",{className:"space-y-1",children:s.products.map(n=>e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center justify-between",children:[e.jsxs("span",{children:["‚Ä¢ ",n.name]}),e.jsxs("span",{className:"font-medium",children:[n.unit_price,"‚Ç¨"]})]},n.id))})]},s.id))]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsx("div",{className:"flex gap-2",children:i>1&&e.jsxs(g,{variant:"outline",onClick:()=>{i===2&&c>0?h(c-1):(x(i-1),h(0))},disabled:a,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Retour"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"ghost",onClick:l,disabled:a,children:"Annuler"}),i===1&&e.jsxs(g,{onClick:()=>x(2),disabled:!R,children:["Suivant",e.jsx(D,{className:"h-4 w-4 ml-2"})]}),i===2&&e.jsxs(g,{onClick:V,disabled:!U,children:[A?"R√©capitulatif":"Cat√©gorie suivante",e.jsx(D,{className:"h-4 w-4 ml-2"})]}),i===3&&e.jsx(g,{onClick:F,disabled:a,children:a?"Cr√©ation en cours...":e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Valider et cr√©er"]})})]})]})]})})}export{pe as C,k as I};
