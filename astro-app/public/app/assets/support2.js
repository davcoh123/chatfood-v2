import{d as x,r as m,s as f,ah as g,j as s,v as u,aA as b,aB as y}from"./index.js";import{f as v,b as j}from"./fr.js";import{o as _,s as p}from"./types.js";const A=e=>{const{user:n}=x(),[l,d]=m.useState([]),[r,c]=m.useState(!1),i=async()=>{if(e)try{c(!0);const{data:o,error:t}=await f.from("ticket_messages").select("*").eq("ticket_id",e).order("created_at",{ascending:!0});if(t)throw t;d(o||[])}catch(o){console.error("Error fetching messages:",o),g({title:"Erreur",description:"Impossible de charger les messages",variant:"destructive"})}finally{c(!1)}},h=async(o,t="user")=>{if(!e||!n)return!1;console.debug("[sendMessage] start",{ticketId:e,senderType:t,userId:n.id});try{const{error:a}=await f.from("ticket_messages").insert({ticket_id:e,sender_id:n.id,sender_type:t,message:o});if(a)throw console.error("[sendMessage] insert error:",a),a;return console.debug("[sendMessage] success"),g({title:"Message envoy√©",description:t==="user"?"Votre message a √©t√© envoy√© √† l'√©quipe support":"Message envoy√© √† l'utilisateur"}),!0}catch(a){return console.error("[sendMessage] error:",a),g({title:"Erreur",description:a.message||"Impossible d'envoyer le message",variant:"destructive"}),!1}};return m.useEffect(()=>{if(e&&n){i();const o=f.channel(`ticket-messages-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"ticket_messages",filter:`ticket_id=eq.${e}`},t=>{t.eventType==="INSERT"&&d(a=>[...a,t.new])}).subscribe();return()=>{f.removeChannel(o)}}},[e,n]),{messages:l,loading:r,sendMessage:h,refreshMessages:i}},E=({messages:e,loading:n})=>{const{user:l}=x(),d=m.useRef(null);return m.useEffect(()=>{var r;(r=d.current)==null||r.scrollIntoView({behavior:"smooth"})},[e]),n?s.jsx("div",{className:"flex items-center justify-center p-8",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.length===0?s.jsx("div",{className:"flex items-center justify-center p-8 text-muted-foreground",children:"Aucun message pour le moment"}):s.jsxs("div",{className:"space-y-4 p-4 max-h-[400px] overflow-y-auto",children:[e.map(r=>{const c=r.sender_id===(l==null?void 0:l.id),i=r.sender_type==="admin";return s.jsxs("div",{className:u("flex gap-3",c?"flex-row-reverse":"flex-row"),children:[s.jsx(b,{className:u("h-8 w-8 shrink-0",i?"bg-primary/10":"bg-secondary"),children:s.jsx(y,{className:u("text-xs",i?"text-primary":"text-secondary-foreground"),children:i?"AD":"US"})}),s.jsxs("div",{className:u("flex flex-col gap-1 max-w-[70%]",c?"items-end":"items-start"),children:[s.jsx("div",{className:u("rounded-lg px-4 py-2",c?"bg-primary text-primary-foreground":i?"bg-secondary text-secondary-foreground":"bg-muted text-foreground"),children:s.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:r.message})}),s.jsx("span",{className:"text-xs text-muted-foreground px-2",children:v(new Date(r.created_at),"dd MMM yyyy '√†' HH:mm",{locale:j})})]})]},r.id)}),s.jsx("div",{ref:d})]})},k=[{value:"add_dish",label:"üçΩÔ∏è Ajouter/Modifier un plat"},{value:"technical_issue",label:"üîß Probl√®me technique"},{value:"billing",label:"üí≥ Question de facturation"},{value:"feature_request",label:"‚ú® Demande de fonctionnalit√©"},{value:"other",label:"üì¶ Autre"}],T=_({ticket_type:p().refine(e=>["add_dish","technical_issue","billing","feature_request","other"].includes(e),{message:"Veuillez s√©lectionner un type de probl√®me"}),subject:p().min(5,"Le sujet doit faire au moins 5 caract√®res").max(100,"Le sujet ne peut pas d√©passer 100 caract√®res"),description:p().min(20,"Veuillez d√©crire votre probl√®me en d√©tail (minimum 20 caract√®res)").max(2e3,"La description ne peut pas d√©passer 2000 caract√®res"),priority:p().default("normal")});export{E as T,T as c,k as t,A as u};
