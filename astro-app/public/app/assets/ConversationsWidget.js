import{F as z,d as P,s as A,r as l,j as e,aA as q,aB as F,D as W,n as H,B as p,X as V,I as J}from"./index.js";import{u as K}from"./useQuery.js";import{Z as L,a as Q,R as X}from"./zoom-out.js";import{D as G}from"./download.js";import{f as Y,b as ee}from"./fr.js";import{L as O}from"./loader-circle.js";import{M as se}from"./message-square.js";import{P as te}from"./phone.js";import{S as ne}from"./send.js";const ae=d=>{z();const{profile:g}=P(),m=d??(g==null?void 0:g.user_id),{data:x,isLoading:b,error:i,refetch:v}=K({queryKey:["conversations",m],queryFn:async()=>{if(!m)return{conversations:[]};const{data:u,error:f}=await A.from("chatbot_messages").select("id, from_number, to_number, customer_name, created_at, message_type, body, status").eq("user_id",m).order("created_at",{ascending:!0});if(f)throw console.error("Error fetching messages:",f),f;if(!u||u.length===0)return{conversations:[]};const c={};for(const t of u){const a=t.status==="send",r=a?t.to_number:t.from_number;c[r]||(c[r]={customerPhone:r,customerName:"Client",messages:[]}),c[r].messages.push({id:t.id,from_number:t.from_number,to_number:t.to_number,customer_name:t.customer_name||"Client",created_at:t.created_at,message_type:t.message_type,body:t.body||"",status:t.status==="send"?"send":"receive"}),!a&&t.customer_name&&!t.customer_name.toLowerCase().includes("chatfood")&&(c[r].customerName=t.customer_name)}return{conversations:Object.values(c).map(t=>{const a=t.messages[t.messages.length-1];return{number:t.customerPhone,name:t.customerName,lastMessage:(a==null?void 0:a.body)||"",lastMessageTime:(a==null?void 0:a.created_at)||"",messages:t.messages}}).sort((t,a)=>new Date(a.lastMessageTime).getTime()-new Date(t.lastMessageTime).getTime())}},enabled:!!m,refetchInterval:3e4});return{conversations:(x==null?void 0:x.conversations)??[],isLoading:b,isRefreshing:!1,error:i,refetch:v}},E=({message:d,time:g,status:m,name:x,messageType:b="text",isPending:i=!1})=>{const[v,u]=l.useState(!1),[f,c]=l.useState(100),[h,j]=l.useState(0),t=n=>{try{return Y(new Date(n),"HH:mm",{locale:ee})}catch{return""}},a=n=>n.replace(/\\n/g,`
`),r=m==="receive",_=b==="image"||d&&d.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)/i),k=()=>c(n=>Math.min(n+20,200)),C=()=>c(n=>Math.max(n-20,50)),S=()=>j(n=>(n+90)%360),N=()=>{c(100),j(0)},I=async()=>{try{const $=await(await fetch(d)).blob(),M=URL.createObjectURL($),w=document.createElement("a");w.href=M,w.download=`image-${Date.now()}.jpg`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(M)}catch(n){console.error("Download failed:",n)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`flex items-start gap-2 mb-3 ${r?"":"justify-end"}`,children:[r&&e.jsx(q,{className:"h-8 w-8 flex-shrink-0",children:e.jsx(F,{className:"bg-muted text-muted-foreground text-xs",children:x.charAt(0).toUpperCase()})}),e.jsxs("div",{className:`flex flex-col ${r?"items-start":"items-end"} max-w-[85%] sm:max-w-[70%] overflow-hidden`,children:[_?e.jsxs("div",{className:"relative cursor-pointer group rounded-lg overflow-hidden",onClick:()=>u(!0),children:[e.jsx("img",{src:d,alt:"Image message",className:"max-w-[200px] max-h-[200px] object-cover rounded-lg",onError:n=>{n.target.style.display="none"}}),e.jsx("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx(L,{className:"h-6 w-6 text-white"})})]}):e.jsxs("div",{className:`rounded-lg px-4 py-2 ${r?"bg-muted text-foreground":"bg-green-500 text-white"} ${i?"opacity-60":""}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:a(d)}),i&&e.jsx("span",{className:"text-[10px] opacity-70",children:"Envoi..."})]}),e.jsx("span",{className:"text-xs mt-1 text-muted-foreground",children:t(g)})]})]}),e.jsx(W,{open:v,onOpenChange:u,children:e.jsx(H,{className:"max-w-[95vw] w-fit max-h-[95vh] p-0 overflow-hidden border",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-background border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{variant:"outline",size:"icon",onClick:C,children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-sm min-w-[50px] text-center font-medium",children:[f,"%"]}),e.jsx(p,{variant:"outline",size:"icon",onClick:k,children:e.jsx(L,{className:"h-4 w-4"})}),e.jsx(p,{variant:"outline",size:"icon",onClick:S,children:e.jsx(X,{className:"h-4 w-4"})}),e.jsx(p,{variant:"outline",size:"sm",onClick:N,children:"Reset"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{variant:"outline",size:"icon",onClick:I,children:e.jsx(G,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>u(!1),children:e.jsx(V,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center overflow-auto p-4 bg-muted/30",style:{height:"calc(95vh - 70px)"},children:e.jsx("img",{src:d,alt:"Preview",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${f/100}) rotate(${h}deg)`,transformOrigin:"center center"}})})]})})})]})},xe=({sectionId:d="conversations",userId:g})=>{const{profile:m}=P(),{toast:x}=z(),b=g||(m==null?void 0:m.user_id)||"",{conversations:i,isLoading:v,isRefreshing:u,error:f,refetch:c}=ae(b),[h,j]=l.useState(null),[t,a]=l.useState(""),[r,_]=l.useState(!1),[k,C]=l.useState(!1),[S,N]=l.useState([]),I=l.useRef(null);l.useEffect(()=>{i.length>0&&!h&&window.innerWidth>=768&&j(i[0].number)},[i,h]),l.useEffect(()=>{var s;(s=I.current)==null||s.scrollIntoView({behavior:"smooth"})},[h,i,S]);const n=i.find(s=>s.number===h),$=S.filter(s=>s.to_number===h),M=s=>{j(s),C(!0)},w=()=>{C(!1)},U=async s=>{if(s.preventDefault(),!t.trim()||!n||r)return;const y=t.trim(),R=`pending-${Date.now()}`,B={id:R,body:y,created_at:new Date().toISOString(),to_number:n.number};N(o=>[...o,B]),a(""),_(!0);try{const{data:o}=await A.from("restaurant_settings").select("phone_number_id, whatsapp_business_id, restaurant_name").eq("user_id",b).single();if(!(await fetch("https://n8n.chatfood.fr/webhook/send-whatsapp-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to_number:n.number,message:y,phone_number_id:o==null?void 0:o.phone_number_id,whatsapp_business_id:o==null?void 0:o.whatsapp_business_id,restaurant_name:o==null?void 0:o.restaurant_name,user_id:b,customer_name:n.name})})).ok)throw new Error("Erreur webhook");x({title:"Message envoyé"}),setTimeout(()=>{c().then(()=>{N(T=>T.filter(Z=>Z.id!==R))})},1500)}catch(o){console.error("Send message error:",o),N(D=>D.filter(T=>T.id!==R)),a(y),x({title:"Erreur",description:"Impossible d'envoyer le message",variant:"destructive"})}finally{_(!1)}};return v?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):f?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("p",{className:"text-muted-foreground text-center",children:"Impossible de charger les conversations. Vérifiez la configuration."})}):i.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(se,{className:"h-12 w-12 text-muted-foreground/50 mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucune conversation pour le moment"})]}):e.jsxs("div",{className:"flex flex-col md:flex-row h-[400px] sm:h-[500px] md:h-[600px] lg:h-[700px] border rounded-lg overflow-hidden bg-background w-full",children:[e.jsx("div",{className:`${k?"hidden":"block"} w-full md:block md:w-[280px] lg:w-[320px] border-b md:border-b-0 md:border-r bg-background h-full`,children:e.jsx("div",{className:"h-full overflow-y-auto",children:e.jsx("div",{className:"p-2 space-y-1",children:i.map(s=>e.jsx("button",{onClick:()=>M(s.number),className:`w-full text-left p-2 sm:p-3 rounded-lg transition-colors hover:bg-muted/50 overflow-hidden ${h===s.number?"bg-muted":""}`,children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 w-full",children:[e.jsx("div",{className:"w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold flex-shrink-0 text-sm sm:text-base",children:s.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0 grid gap-0.5",children:[e.jsxs("div",{className:"flex justify-between items-center gap-2 w-full",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:s.name}),e.jsx("span",{className:"text-[10px] text-muted-foreground whitespace-nowrap shrink-0",children:new Date(s.lastMessageTime).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate block w-full",children:s.lastMessage})]})]})},s.number))})})}),e.jsx("div",{className:`${k?"flex":"hidden"} md:flex flex-col flex-1 h-full`,children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-3 md:p-4 border-b bg-green-600 text-white",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(p,{variant:"ghost",size:"icon",className:"md:hidden text-white hover:bg-white/20 -ml-2",onClick:w,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"m15 18-6-6 6-6"})})}),e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/20 flex items-center justify-center font-semibold flex-shrink-0",children:n.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-semibold truncate",children:n.name}),e.jsxs("p",{className:"text-xs text-white/80 flex items-center gap-1",children:[e.jsx(te,{className:"h-3 w-3 shrink-0"}),e.jsxs("span",{className:"truncate max-w-[120px] sm:max-w-none",children:["+",n.number.toString().replace(/(\d{2})(\d{1})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1 $2 $3 $4 $5 $6")]})]})]})]}),u]})}),e.jsx("div",{className:"flex-1 p-4 bg-gray-50 overflow-y-auto",children:e.jsxs("div",{className:"space-y-2",children:[n.messages.map((s,y)=>e.jsx(E,{message:s.body,time:s.created_at,status:s.status,name:n.name,messageType:s.message_type},`${s.id}-${y}`)),$.map(s=>e.jsx(E,{message:s.body,time:s.created_at,status:"send",name:n.name,messageType:"text",isPending:!0},s.id)),e.jsx("div",{ref:I})]})}),e.jsx("div",{className:"p-3 border-t bg-background",children:e.jsxs("form",{onSubmit:U,className:"flex gap-2",children:[e.jsx(J,{value:t,onChange:s=>a(s.target.value),placeholder:"Écrire un message...",className:"flex-1",disabled:r}),e.jsx(p,{type:"submit",disabled:!t.trim()||r,className:"bg-green-600 hover:bg-green-700",children:r?e.jsx(O,{className:"h-4 w-4 animate-spin"}):e.jsx(ne,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"hidden md:flex items-center justify-center h-full",children:e.jsx("p",{className:"text-muted-foreground",children:"Sélectionnez une conversation"})})})]})};export{xe as C};
