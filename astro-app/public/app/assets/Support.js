import{d as ce,r as m,s as E,ah as g,j as e,D as Y,n as Z,o as $,p as ee,q as se,v as de,t as re,B as w,ay as ue,i as B,e as f,C as I,a as V,b as H,g as L,c as P,I as O,M as me}from"./index.js";import{u as xe,t as pe}from"./zod.js";import{u as he,t as A,T as ve,c as je}from"./support2.js";import{F as ge,a as b,b as y,c as N,d as C,e as S,f as fe}from"./form.js";import{T as te}from"./textarea.js";import{S as K,a as U,b as G,c as J,d as M}from"./select.js";import{S as z}from"./star.js";import{S as Q}from"./send.js";import{C as W}from"./circle-check.js";import{C as we}from"./circle-alert.js";import{C as X}from"./clock.js";import{f as be,b as ye}from"./fr.js";import"./types.js";import"./label.js";import"./index4.js";import"./index3.js";import"./index5.js";import"./check.js";const Ne=()=>{const{user:c}=ce(),[v,d]=m.useState(!1);return{submitReview:async(r,t,n)=>{if(!c)return g({title:"Erreur",description:"Vous devez Ãªtre connectÃ©",variant:"destructive"}),!1;try{d(!0);const{error:i}=await E.from("ticket_reviews").upsert({ticket_id:r,user_id:c.id,rating:t,comment:n||null},{onConflict:"ticket_id"});if(i)throw console.error("Error submitting review:",i),i;const{error:o}=await E.from("support_tickets").update({status:"resolved",awaiting_review:!1,resolved_at:new Date().toISOString()}).eq("id",r);if(o)throw console.error("Error updating ticket:",o),o;return g({title:"Merci pour votre avis !",description:"Votre Ã©valuation a Ã©tÃ© enregistrÃ©e"}),!0}catch(i){return g({title:"Erreur",description:i.message||"Impossible d'enregistrer votre avis",variant:"destructive"}),!1}finally{d(!1)}},reopenTicket:async r=>{if(!c)return!1;try{const{error:t}=await E.from("support_tickets").update({status:"open",awaiting_review:!1}).eq("id",r);if(t)throw t;return g({title:"Ticket rouvert",description:"Vous pouvez continuer la conversation"}),!0}catch(t){return console.error("Error reopening ticket:",t),g({title:"Erreur",description:"Impossible de rouvrir le ticket",variant:"destructive"}),!1}},submitting:v}},Ce=({open:c,onClose:v,onSubmit:d})=>{const[x,h]=m.useState(0),[r,t]=m.useState(0),[n,i]=m.useState(""),[o,p]=m.useState(!1),k=()=>{h(0),t(0),i(""),v()},_=async()=>{x!==0&&(p(!0),await d(x,n),p(!1))};return e.jsx(Y,{open:c,onOpenChange:k,children:e.jsxs(Z,{className:"sm:max-w-md",children:[e.jsxs($,{children:[e.jsx(ee,{children:"Ã‰valuer le support"}),e.jsx(se,{children:"Comment Ã©valuez-vous la qualitÃ© du support reÃ§u ?"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsx("div",{className:"flex justify-center gap-2",children:[1,2,3,4,5].map(u=>e.jsx("button",{type:"button",onClick:()=>h(u),onMouseEnter:()=>t(u),onMouseLeave:()=>t(0),className:"transition-transform hover:scale-110",children:e.jsx(z,{className:de("h-8 w-8 transition-colors",(r||x)>=u?"fill-yellow-400 text-yellow-400":"text-muted-foreground")})},u))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Commentaire (optionnel)"}),e.jsx(te,{value:n,onChange:u=>i(u.target.value),placeholder:"Partagez votre expÃ©rience...",rows:4})]})]}),e.jsx(re,{children:e.jsx(w,{onClick:_,disabled:x===0||o,className:"w-full",children:o?"Envoi en cours...":"Envoyer l'Ã©valuation"})})]})})};function Ae(){const{tickets:c,loading:v,unreadCount:d,createTicket:x,refreshTickets:h}=ue(),[r,t]=m.useState(null),[n,i]=m.useState(""),[o,p]=m.useState(!1),{messages:k,loading:_,sendMessage:u}=he(r==null?void 0:r.id),{submitReview:ae,reopenTicket:ie}=Ne(),l=xe({resolver:pe(je),defaultValues:{ticket_type:"",subject:"",description:"",priority:"normal"}}),ne=async s=>{try{await x(s)&&l.reset()}catch(a){console.error("[Support] Unexpected error in onSubmit:",a)}},T=async()=>{if(!n.trim()||!r)return;await u(n,"user")&&i("")},oe=()=>{r!=null&&r.awaiting_review?p(!0):t(null)},R=(s,a)=>{if(a)return e.jsxs(f,{variant:"outline",className:"gap-1 border-yellow-500 text-yellow-600",children:[e.jsx(z,{className:"h-3 w-3"}),"En attente d'Ã©valuation"]});const j={open:{variant:"default",icon:X,label:"Ouvert"},awaiting_admin:{variant:"default",icon:X,label:"En attente"},awaiting_user:{variant:"destructive",icon:me,label:"ðŸ”´ Nouvelle rÃ©ponse"},in_progress:{variant:"secondary",icon:we,label:"En cours"},resolved:{variant:"outline",icon:W,label:"RÃ©solu"},closed:{variant:"outline",icon:W,label:"FermÃ©"}},D=j[s]||j.open,le=D.icon;return e.jsxs(f,{variant:D.variant,className:"gap-1",children:[e.jsx(le,{className:"h-3 w-3"}),D.label]})},F=s=>s==="high"?e.jsx(f,{variant:"destructive",children:"Haute"}):e.jsx(f,{variant:"secondary",children:"Normale"}),q=s=>{var a;return((a=A.find(j=>j.value===s))==null?void 0:a.label)||s};return e.jsxs("div",{className:"container mx-auto py-4 md:py-8 px-4 space-y-6 md:space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-primary/10 p-3 rounded-lg",children:e.jsx(B,{className:"h-6 w-6 md:h-8 md:w-8 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"Besoin d'aide ?"}),e.jsx("p",{className:"text-sm md:text-base text-muted-foreground",children:"Contactez notre Ã©quipe support"})]})]}),d>0&&e.jsxs(f,{variant:"destructive",className:"md:ml-auto w-fit",children:[d," nouveau",d>1?"x":""]})]}),e.jsxs("div",{className:"grid gap-6 md:gap-8 lg:grid-cols-2",children:[e.jsxs(I,{children:[e.jsxs(V,{children:[e.jsx(H,{children:"CrÃ©er un nouveau ticket"}),e.jsx(L,{children:"DÃ©crivez votre problÃ¨me en dÃ©tail. Notre Ã©quipe vous rÃ©pondra rapidement."})]}),e.jsx(P,{children:e.jsx(ge,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(ne),className:"space-y-4 md:space-y-6",children:[e.jsx(b,{control:l.control,name:"ticket_type",render:({field:s})=>e.jsxs(y,{children:[e.jsx(N,{children:"Type de problÃ¨me"}),e.jsxs(K,{onValueChange:s.onChange,value:s.value,children:[e.jsx(C,{children:e.jsx(U,{children:e.jsx(G,{placeholder:"SÃ©lectionnez un type"})})}),e.jsx(J,{children:A.map(a=>e.jsx(M,{value:a.value,children:a.label},a.value))})]}),e.jsx(S,{})]})}),e.jsx(b,{control:l.control,name:"subject",render:({field:s})=>e.jsxs(y,{children:[e.jsx(N,{children:"Sujet"}),e.jsx(C,{children:e.jsx(O,{placeholder:"RÃ©sumÃ© court de votre problÃ¨me",...s})}),e.jsx(S,{})]})}),e.jsx(b,{control:l.control,name:"description",render:({field:s})=>e.jsxs(y,{children:[e.jsx(N,{children:"Description dÃ©taillÃ©e"}),e.jsx(C,{children:e.jsx(te,{placeholder:"DÃ©crivez votre problÃ¨me en dÃ©tail. Plus vous donnez d'informations, plus vite nous pourrons vous aider !",className:"min-h-[150px] resize-none",...s})}),e.jsx(fe,{className:s.value.length>0&&s.value.length<20?"text-destructive font-medium":"",children:"Minimum 20 caractÃ¨res - Soyez le plus prÃ©cis possible"}),e.jsx(S,{})]})}),e.jsx(b,{control:l.control,name:"priority",render:({field:s})=>e.jsxs(y,{children:[e.jsx(N,{children:"PrioritÃ©"}),e.jsxs(K,{onValueChange:s.onChange,value:s.value,children:[e.jsx(C,{children:e.jsx(U,{children:e.jsx(G,{})})}),e.jsxs(J,{children:[e.jsx(M,{value:"normal",children:"Normale"}),e.jsx(M,{value:"high",children:"Haute (urgent)"})]})]}),e.jsx(S,{})]})}),e.jsxs(w,{type:"submit",className:"w-full",size:"lg",disabled:l.formState.isSubmitting,children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),l.formState.isSubmitting?"Envoi en cours...":"Envoyer le ticket"]})]})})})]}),e.jsxs(I,{children:[e.jsxs(V,{children:[e.jsx(H,{children:"Mes tickets"}),e.jsx(L,{children:"Historique de vos demandes de support"})]}),e.jsx(P,{children:v?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Chargement..."}):c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Aucun ticket pour le moment"})]}):e.jsx("div",{className:"space-y-3",children:c.filter(s=>s.status!=="resolved"&&s.status!=="closed").map(s=>e.jsx("div",{className:"p-3 md:p-4 border rounded-lg hover:bg-muted/50 cursor-pointer transition-colors",onClick:()=>t(s),children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start justify-between gap-2 sm:gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 flex-wrap",children:[R(s.status,s.awaiting_review),F(s.priority)]}),e.jsx("h4",{className:"font-medium truncate",children:s.subject}),e.jsx("p",{className:"text-sm text-muted-foreground",children:q(s.ticket_type)})]}),e.jsx("div",{className:"text-xs text-muted-foreground sm:text-right whitespace-nowrap",children:be(new Date(s.last_message_at||s.created_at),"dd MMM yyyy",{locale:ye})})]})},s.id))})})]})]}),e.jsx(Y,{open:!!r&&!o,onOpenChange:oe,children:e.jsxs(Z,{className:"max-w-3xl max-h-[90vh] flex flex-col",children:[e.jsxs($,{children:[e.jsxs(ee,{children:["Conversation - ",r==null?void 0:r.subject]}),e.jsxs(se,{children:["Ticket #",r==null?void 0:r.id.slice(0,8)," â€¢ ",q(r==null?void 0:r.ticket_type)]})]}),r&&e.jsxs("div",{className:"flex-1 flex flex-col gap-4 min-h-0",children:[e.jsxs("div",{className:"flex gap-2",children:[R(r.status,r.awaiting_review),F(r.priority)]}),e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Description initiale"}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:r.description})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-background",children:e.jsx(ve,{messages:k,loading:_})}),!r.awaiting_review&&r.status!=="resolved"&&r.status!=="closed"&&e.jsx(re,{className:"flex-row gap-2 sm:gap-2",children:e.jsxs("div",{className:"flex-1 flex gap-2",children:[e.jsx(O,{value:n,onChange:s=>i(s.target.value),placeholder:"Ã‰crivez votre message...",onKeyPress:s=>s.key==="Enter"&&!s.shiftKey&&T(),className:"flex-1"}),e.jsx(w,{onClick:T,disabled:!n.trim(),children:e.jsx(Q,{className:"h-4 w-4"})})]})}),r.awaiting_review&&e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200 mb-3 text-center",children:"Notre Ã©quipe a marquÃ© ce ticket comme rÃ©solu"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsxs(w,{onClick:()=>p(!0),size:"sm",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Ã‰valuer le support"]}),e.jsx(w,{variant:"outline",size:"sm",onClick:async()=>{await ie(r.id)&&(t(null),await h())},children:"Rouvrir la discussion"})]})]})]})]})}),r&&e.jsx(Ce,{open:o,onClose:()=>{p(!1),t(null)},onSubmit:async(s,a)=>{await ae(r.id,s,a)&&(p(!1),t(null),await h())}})]})}export{Ae as default};
