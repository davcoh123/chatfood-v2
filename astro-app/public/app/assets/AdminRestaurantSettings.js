import{r as n,j as e,S as Fe,e as te,J as Se,K as ye,N as Ae,O as Ce,y as Ge,C as $,a as ce,h as I,c as de,b as we,g as Te,I as h,B as O,s as f,l as Be,m as A,G as He,U as $e}from"./index.js";import{S as pe,a as he,b as xe,c as ge,d as H}from"./select.js";import{L as c}from"./label.js";import{A as _e,a as be}from"./alert.js";import{S as Qe}from"./switch.js";import{T as Re,a as ke,b as U,c as q}from"./tabs.js";import{A as Ve,a as Je,b as Ke,c as Ye,d as Ze,e as Xe,f as es,g as ss,h as ts}from"./alert-dialog.js";import{u as as}from"./useDeleteAccount.js";import{u as rs}from"./useRestaurantSettings.js";import ns from"./purify.es.js";import{T as is}from"./textarea.js";import{S as ls}from"./scroll-area.js";import{I as Ee,C as os}from"./info.js";import{E as Ie}from"./eye.js";import{u as cs}from"./useCatalogue.js";import{A as ds,W as ve}from"./WhatsAppOnboardingButton.js";import{u as us}from"./useWhatsAppIntegration.js";import{T as je}from"./triangle-alert.js";import{T as We}from"./trash-2.js";import{C as ms}from"./circle-check-big.js";import{S as De}from"./save.js";import{M as ps}from"./message-square.js";import{E as hs,U as xs,R as gs}from"./unplug.js";import{L as ie}from"./loader-circle.js";import{P as js}from"./plus.js";import"./index4.js";import"./index3.js";import"./index5.js";import"./check.js";import"./index2.js";import"./useQuery.js";import"./search.js";import"./popover.js";import"./map-pin.js";import"./circle-alert.js";const le=[{key:"[[RESTAURANT_NAME]]",description:"Nom du restaurant",color:"bg-blue-500/20 text-blue-700 border-blue-300"},{key:"[[ADDRESS]]",description:"Adresse compl√®te",color:"bg-green-500/20 text-green-700 border-green-300"},{key:"[[OPENING_HOURS]]",description:"Horaires d'ouverture",color:"bg-purple-500/20 text-purple-700 border-purple-300"},{key:"[[CATEGORIES]]",description:"Liste des cat√©gories",color:"bg-orange-500/20 text-orange-700 border-orange-300"},{key:"[[ASSETS]]",description:"URLs et descriptions des images",color:"bg-pink-500/20 text-pink-700 border-pink-300"},{key:"[[ORDER_WAIT_TIME]]",description:"Temps d'attente commande (minutes)",color:"bg-cyan-500/20 text-cyan-700 border-cyan-300"}],oe=[{key:"{{NOW}}",description:"Date et heure actuelles",color:"bg-amber-500/20 text-amber-700 border-amber-300"},{key:"{{CUSTOMER_NAME}}",description:"Nom du client WhatsApp",color:"bg-red-500/20 text-red-700 border-red-300"},{key:"{{USER_MESSAGE}}",description:"Message du client",color:"bg-red-500/20 text-red-700 border-red-300"}],fe=`Tu es l'assistant virtuel de [[RESTAURANT_NAME]], un chatbot WhatsApp intelligent sp√©cialis√© dans la prise de commande et le service client pour la restauration.

## üè† INFORMATIONS DU RESTAURANT

**Nom :** [[RESTAURANT_NAME]]
**Adresse :** [[ADDRESS]]
**Temps d'attente estim√© pour r√©cup√©rer une commande :** [[ORDER_WAIT_TIME]] minutes

**Horaires d'ouverture :**
[[OPENING_HOURS]]

## üìã CAT√âGORIES DU CATALOGUE

Les cat√©gories disponibles sont : [[CATEGORIES]]

## üñºÔ∏è IMAGES ET ASSETS DISPONIBLES

Tu peux envoyer ces images aux clients si pertinent :
[[ASSETS]]

## üìú R√àGLES DE COMPORTEMENT

1. **Accueil** : Salue chaleureusement chaque nouveau client
2. **Langue** : R√©ponds toujours dans la langue du client
3. **Prise de commande** : Guide le client √† travers le menu, propose des suggestions
4. **R√©servations** : G√®re les demandes de r√©servation
5. **Questions** : R√©ponds aux questions sur les allerg√®nes, ingr√©dients, horaires
6. **Politesse** : Reste toujours poli, professionnel et serviable
7. **Clarification** : Si une demande est ambigu√´, demande des pr√©cisions

## ‚öôÔ∏è FORMAT DE R√âPONSE

- Utilise des emojis avec parcimonie pour rendre les messages chaleureux
- Sois concis mais informatif
- Propose toujours une action suivante au client

---

## üîÑ BLOC DYNAMIQUE (inject√© automatiquement par n8n √† chaque requ√™te)

**Contexte temporel :**
- Date et heure actuelles : {{NOW}}

**Informations client :**
- Nom du client WhatsApp : {{CUSTOMER_NAME}}

**Message √† traiter :**
{{USER_MESSAGE}}
`;function fs({value:p,onChange:m,restaurantName:d="Mon Restaurant",openingHours:l=`Lundi: 12h-14h, 19h-23h
Mardi: 12h-14h, 19h-23h
Mercredi: Ferm√©
Jeudi: 12h-14h, 19h-23h
Vendredi: 12h-14h, 19h-00h
Samedi: 19h-00h
Dimanche: 12h-15h`,categories:Q="Pizzas, Burgers, P√¢tes, Salades, Desserts, Boissons",assets:L=`Menu principal = https://dcwfgxbwpecnjbhrhrib.supabase.co/storage/v1/object/public/assets/menu.jpg
Logo du restaurant = https://dcwfgxbwpecnjbhrhrib.supabase.co/storage/v1/object/public/assets/logo.png`,address:z="123 Rue de la Paix, 75001 Paris",orderWaitTime:T=30,defaultTemplate:x}){const[F,Z]=n.useState("edit"),G=n.useMemo(()=>{const i=S=>{const g=document.createElement("div");return g.textContent=S,g.innerHTML};let r=i(p||fe);const D=i(d),M=i(z),s=i(l),v=i(Q),R=i(L);return r=r.replace(/\[\[RESTAURANT_NAME\]\]/g,`<span class="bg-blue-500/30 px-1 rounded font-medium">${D}</span>`),r=r.replace(/\[\[ADDRESS\]\]/g,`<span class="bg-green-500/30 px-1 rounded font-medium">${M}</span>`),r=r.replace(/\[\[OPENING_HOURS\]\]/g,`<span class="bg-purple-500/30 px-1 rounded font-medium">${s}</span>`),r=r.replace(/\[\[CATEGORIES\]\]/g,`<span class="bg-orange-500/30 px-1 rounded font-medium">${v}</span>`),r=r.replace(/\[\[ASSETS\]\]/g,`<span class="bg-pink-500/30 px-1 rounded font-medium">${R}</span>`),r=r.replace(/\[\[ORDER_WAIT_TIME\]\]/g,`<span class="bg-cyan-500/30 px-1 rounded font-medium">${T}</span>`),r=r.replace(/\{\{NOW\}\}/g,'<span class="bg-amber-500/30 px-1 rounded font-mono text-xs">{{NOW}}</span>'),r=r.replace(/\{\{CUSTOMER_NAME\}\}/g,'<span class="bg-red-500/30 px-1 rounded font-mono text-xs">{{CUSTOMER_NAME}}</span>'),r=r.replace(/\{\{USER_MESSAGE\}\}/g,'<span class="bg-red-500/30 px-1 rounded font-mono text-xs">{{USER_MESSAGE}}</span>'),ns.sanitize(r,{ALLOWED_TAGS:["span"],ALLOWED_ATTR:["class"]})},[p,d,l,Q,L,z,T]),C=n.useMemo(()=>{const i=p||"";return{static:le.filter(r=>i.includes(r.key)).length,dynamic:oe.filter(r=>i.includes(r.key)).length,total:le.length+oe.length}},[p]),W=i=>{const r=document.getElementById("prompt-textarea");if(r){const D=r.selectionStart,M=r.selectionEnd,s=p.slice(0,D)+i+p.slice(M);m(s),setTimeout(()=>{r.selectionStart=r.selectionEnd=D+i.length,r.focus()},0)}else m(p+i)},P=()=>{m(x||fe)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-medium",children:"Prompt Syst√®me IA"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(te,{variant:"outline",className:"text-xs",children:[C.static,"/",le.length," statiques"]}),e.jsxs(te,{variant:"outline",className:"text-xs",children:[C.dynamic,"/",oe.length," dynamiques"]})]})]}),e.jsxs(_e,{children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsxs(be,{className:"text-xs",children:["Les placeholders ",e.jsx("code",{className:"bg-blue-500/20 px-1 rounded",children:"[[...]]"})," sont remplac√©s par les donn√©es Supabase. Les variables ",e.jsxs("code",{className:"bg-amber-500/20 px-1 rounded",children:["{{"," ... ","}}"]})," sont inject√©es par n8n √† chaque requ√™te."]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(c,{className:"text-xs text-muted-foreground mb-2 block",children:"Placeholders statiques (Supabase)"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:le.map(i=>e.jsx(Se,{children:e.jsxs(ye,{children:[e.jsx(Ae,{asChild:!0,children:e.jsx("button",{type:"button",onClick:()=>W(i.key),className:`px-2 py-1 text-xs rounded border font-mono hover:opacity-80 transition-opacity ${i.color}`,children:i.key})}),e.jsx(Ce,{children:e.jsx("p",{children:i.description})})]})},i.key))})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-xs text-muted-foreground mb-2 block",children:"Variables dynamiques (n8n)"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:oe.map(i=>e.jsx(Se,{children:e.jsxs(ye,{children:[e.jsx(Ae,{asChild:!0,children:e.jsx("button",{type:"button",onClick:()=>W(i.key),className:`px-2 py-1 text-xs rounded border font-mono hover:opacity-80 transition-opacity ${i.color}`,children:i.key})}),e.jsx(Ce,{children:e.jsx("p",{children:i.description})})]})},i.key))})]})]}),e.jsxs(Re,{value:F,onValueChange:Z,className:"w-full",children:[e.jsxs(ke,{className:"grid w-full grid-cols-2",children:[e.jsxs(U,{value:"edit",className:"flex items-center gap-2",children:[e.jsx(os,{className:"h-4 w-4"}),"√âditer"]}),e.jsxs(U,{value:"preview",className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4"}),"Aper√ßu"]})]}),e.jsx(q,{value:"edit",className:"mt-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(c,{htmlFor:"prompt-textarea",children:"Contenu du prompt"}),e.jsx("button",{type:"button",onClick:P,className:"text-xs text-primary hover:underline",children:"Utiliser le template par d√©faut"})]}),e.jsx(is,{id:"prompt-textarea",value:p,onChange:i=>m(i.target.value),placeholder:fe,className:"min-h-[400px] font-mono text-sm resize-y"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(p||"").length," caract√®res"]})]})}),e.jsx(q,{value:"preview",className:"mt-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Aper√ßu avec donn√©es r√©elles"}),e.jsx(ls,{className:"h-[400px] w-full rounded-md border bg-muted/30 p-4",children:e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none whitespace-pre-wrap font-mono text-sm",dangerouslySetInnerHTML:{__html:G}})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Les placeholders statiques sont remplac√©s par vos donn√©es actuelles. Les variables dynamiques restent visibles car elles seront inject√©es par n8n."})]})})]}),C.static===0&&p&&p.length>0&&e.jsxs(_e,{children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsxs(be,{children:["Aucun placeholder statique ",e.jsx("code",{className:"bg-blue-500/20 px-1 rounded",children:"[[...]]"})," d√©tect√©. Vous pouvez en ajouter pour personnaliser automatiquement le prompt avec les donn√©es du restaurant."]})]})]})}const _s=["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"];function bs({userId:p,isAdminView:m=!1}){const{settings:d,isLoading:l,updateSettings:Q,isUpdating:L}=rs(p),{plan:z}=Ge(),{items:T}=cs({userId:p}),{integration:x,refetch:F}=us(p,m),{deleteAccount:Z,isDeleting:G}=as(),C=z==="starter",[W,P]=n.useState(""),[i,r]=n.useState(""),[D,M]=n.useState(""),[s,v]=n.useState(!0),[R,S]=n.useState(""),[g,k]=n.useState(""),[V,E]=n.useState(""),[J,X]=n.useState(""),[N,ae]=n.useState([]),[K,ue]=n.useState([]),[re,ee]=n.useState(""),[ne,t]=n.useState(""),[u,j]=n.useState(""),[w,B]=n.useState(""),[Me,Oe]=n.useState(""),[Pe,Ue]=n.useState("");n.useEffect(()=>{(async()=>{var _;const{data:o}=await f.from("system_settings").select("setting_value").eq("setting_key","starter_prompt_template").maybeSingle();if(o!=null&&o.setting_value){const Y=typeof o.setting_value=="string"?o.setting_value:((_=o.setting_value)==null?void 0:_.template)||"";B(Y)}})()},[]),n.useEffect(()=>{d&&(r(d.restaurant_name||""),M(d.chatbot_name),v(d.chatbot_active),S(d.chatbot_prompt||""),k(d.address_street||""),E(d.address_postal_code||""),X(d.address_city||""),ae(d.opening_hours),ue(d.assets||[]),ee(d.phone_number_id||""),t(d.whatsapp_business_id||""),j(d.reservations_webhook_url||""),Oe(d.theme_color||""),Ue(d.cover_image_url||""))},[d]);const y=n.useMemo(()=>{const a=N.filter(b=>b.slot1||b.slot2).map(b=>`${b.day}: ${[b.slot1,b.slot2].filter(Boolean).join(", ")}`).join(`
`)||"Non renseign√©",o=K.length>0?K.map(b=>`${b.description||b.filename} = ${b.url}`).join(`
`):"Aucun asset configur√©",_=[g,V,J].filter(Boolean).join(", ")||"Non renseign√©e",Y=[...new Set(T.filter(b=>b.is_active).map(b=>b.category))],se=Y.length>0?Y.join(", "):"Aucune cat√©gorie (catalogue vide)",ze=(d==null?void 0:d.order_time_minutes)??30;return{restaurantName:i||"Mon Restaurant",openingHours:a,assets:o,address:_,categories:se,orderWaitTime:ze}},[i,N,K,g,V,J,T,d]),Ne=(a,o,_)=>{ae(Y=>Y.map(se=>se.day===a?{...se,[o]:_}:se))},qe=a=>{if(!a)return null;let o=a;return o=o.replace(/\[\[RESTAURANT_NAME\]\]/g,y.restaurantName),o=o.replace(/\[\[ADDRESS\]\]/g,y.address),o=o.replace(/\[\[OPENING_HOURS\]\]/g,y.openingHours),o=o.replace(/\[\[CATEGORIES\]\]/g,y.categories),o=o.replace(/\[\[ASSETS\]\]/g,y.assets),o=o.replace(/\[\[ORDER_WAIT_TIME\]\]/g,String(y.orderWaitTime)),o},me=T&&T.length>0,Le=()=>{const a=C&&!m?"ChatFood":D,o=me||m?s:!1,_=qe(R);Q({restaurant_name:i||null,chatbot_name:a,chatbot_active:o,chatbot_prompt:_,address_street:g||null,address_postal_code:V||null,address_city:J||null,opening_hours:N,assets:K,phone_number_id:re||null,whatsapp_business_id:ne||null,reservations_webhook_url:u||null,theme_color:Me||null,cover_image_url:Pe||null})};return l?e.jsxs($,{children:[e.jsxs(ce,{children:[e.jsx(I,{className:"h-8 w-64"}),e.jsx(I,{className:"h-4 w-96"})]}),e.jsxs(de,{className:"space-y-6",children:[e.jsx(I,{className:"h-10 w-full"}),e.jsx(I,{className:"h-10 w-full"}),e.jsx(I,{className:"h-32 w-full"})]})]}):e.jsxs($,{children:[e.jsxs(ce,{children:[e.jsx(we,{children:"Param√®tres du Restaurant"}),e.jsx(Te,{children:"Configurez toutes les informations de votre restaurant"})]}),e.jsxs(de,{children:[e.jsxs(Re,{defaultValue:"general",className:"space-y-4",children:[e.jsxs(ke,{className:`grid w-full ${m?"grid-cols-6":"grid-cols-3"}`,children:[e.jsx(U,{value:"general",children:"G√©n√©ral"}),e.jsx(U,{value:"chatbot",children:"Chatbot"}),e.jsx(U,{value:"location",children:"Localisation"}),m&&e.jsxs(e.Fragment,{children:[e.jsx(U,{value:"whatsapp",children:"WhatsApp"}),e.jsx(U,{value:"integrations",children:"Int√©grations"}),e.jsx(U,{value:"prompt",children:"Prompt IA"})]})]}),e.jsxs(q,{value:"general",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"restaurant-name",children:"Nom du restaurant"}),e.jsx(h,{id:"restaurant-name",value:i,onChange:a=>r(a.target.value),placeholder:"Le Gourmet"})]}),!m&&e.jsx("div",{className:"mt-8 pt-6 border-t border-destructive/20",children:e.jsxs("div",{className:"bg-destructive/5 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-destructive font-semibold flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4"}),"Zone de danger"]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"La suppression de votre compte est irr√©versible. Toutes vos donn√©es seront d√©finitivement supprim√©es."}),e.jsxs(Ve,{children:[e.jsx(Je,{asChild:!0,children:e.jsxs(O,{variant:"destructive",className:"mt-4",children:[e.jsx(We,{className:"h-4 w-4 mr-2"}),"Supprimer mon compte"]})}),e.jsxs(Ke,{children:[e.jsxs(Ye,{children:[e.jsx(Ze,{children:"√ätes-vous absolument s√ªr ?"}),e.jsx(Xe,{asChild:!0,children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{children:"Cette action est irr√©versible. Cela supprimera d√©finitivement :"}),e.jsxs("ul",{className:"list-disc list-inside text-sm space-y-1",children:[e.jsx("li",{children:"Votre restaurant et tous ses param√®tres"}),e.jsx("li",{children:"Tous vos produits et menus"}),e.jsx("li",{children:"Tout l'historique des commandes"}),e.jsx("li",{children:"Toutes les conversations WhatsApp"}),e.jsx("li",{children:"Toutes les r√©servations"}),e.jsx("li",{children:"Vos informations de profil"})]}),e.jsx("p",{className:"font-medium",children:"Tapez SUPPRIMER pour confirmer."})]})})]}),e.jsx(h,{placeholder:"Tapez SUPPRIMER pour confirmer",value:W,onChange:a=>P(a.target.value.toUpperCase()),className:"font-mono"}),e.jsxs(es,{children:[e.jsx(ss,{onClick:()=>P(""),children:"Annuler"}),e.jsx(ts,{disabled:W!=="SUPPRIMER"||G,onClick:()=>{Z(W),P("")},className:"bg-destructive hover:bg-destructive/90",children:G?"Suppression...":"Supprimer d√©finitivement"})]})]})]})]})})]}),e.jsxs(q,{value:"chatbot",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"chatbot-name",children:"Nom du chatbot"}),e.jsx(h,{id:"chatbot-name",value:D,onChange:a=>M(a.target.value),placeholder:"ChatFood",disabled:C&&!m,className:C&&!m?"bg-muted cursor-not-allowed":""}),C&&!m&&e.jsx("p",{className:"text-xs text-muted-foreground",children:'üí° Le nom "ChatFood" est fixe pour le plan Starter. Passez au plan Pro pour le personnaliser.'})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-border p-4",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(c,{htmlFor:"chatbot-active",children:"Chatbot actif"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Activer ou d√©sactiver le chatbot"}),!me&&!m&&e.jsxs("p",{className:"text-sm text-amber-600 flex items-center gap-1.5 mt-2",children:[e.jsx(je,{className:"h-4 w-4"}),"Le chatbot ne peut pas √™tre activ√© tant que le catalogue est vide."]})]}),e.jsx(Qe,{id:"chatbot-active",checked:s,onCheckedChange:v,disabled:!me&&!m})]})]}),e.jsxs(q,{value:"location",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(c,{className:"text-base",children:"Adresse du restaurant"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"address-street",children:"Rue"}),e.jsx(ds,{id:"address-street",value:g,onChange:k,onAddressSelect:a=>{k(a.street),E(a.postalCode),X(a.city)},placeholder:"Ex: 12 rue de la Paix"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"address-postal",children:"Code postal"}),e.jsx(h,{id:"address-postal",value:V,onChange:a=>E(a.target.value),placeholder:"75001"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"address-city",children:"Ville"}),e.jsx(h,{id:"address-city",value:J,onChange:a=>X(a.target.value),placeholder:"Paris"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(c,{className:"text-base",children:"Horaires d'ouverture"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Indiquez les horaires au format libre (ex: 12h-14h, 19h-23h)"})]}),e.jsx("div",{className:"space-y-4",children:_s.map(a=>{const o=N.find(_=>_.day===a)||{slot1:"",slot2:""};return e.jsxs("div",{className:"space-y-3 p-4 rounded-lg border",children:[e.jsx("span",{className:"font-medium capitalize text-base",children:a}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Service midi"}),e.jsx(h,{value:o.slot1,onChange:_=>Ne(a,"slot1",_.target.value),placeholder:"12h-14h",className:"text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Service soir (optionnel)"}),e.jsx(h,{value:o.slot2,onChange:_=>Ne(a,"slot2",_.target.value),placeholder:"19h-23h",className:"text-sm"})]})]})]},a)})})]})]}),m&&e.jsxs(e.Fragment,{children:[e.jsxs(q,{value:"whatsapp",className:"space-y-4",children:[x?e.jsx($,{className:`p-4 ${x.status==="active"?"bg-green-50 border-green-200 dark:bg-green-950/20 dark:border-green-800":"bg-amber-50 border-amber-200 dark:bg-amber-950/20 dark:border-amber-800"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[x.status==="active"?e.jsx(ms,{className:"h-5 w-5 text-green-600 dark:text-green-400"}):e.jsx(je,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),e.jsxs("div",{children:[e.jsx("p",{className:`font-medium ${x.status==="active"?"text-green-700 dark:text-green-400":"text-amber-700 dark:text-amber-400"}`,children:x.status==="active"?"WhatsApp connect√©":"WhatsApp d√©connect√©"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[x.display_phone_number||x.phone_number_id||"Aucun num√©ro",x.verified_name&&` ‚Ä¢ ${x.verified_name}`]})]})]})}):e.jsx($,{className:"p-4 bg-muted/50 border-dashed",children:e.jsx("p",{className:"text-muted-foreground text-sm",children:"Aucune int√©gration WhatsApp"})}),e.jsx($,{className:"p-4 border-2 border-primary/20 bg-primary/5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Connecter WhatsApp Business"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connectez le compte WhatsApp Business du client via Meta Embedded Signup"})]}),e.jsx(ve,{existingIntegration:x,onSuccess:a=>{ee(a.phone_number_id),t(a.waba_id),F()}})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"phone-number-id",children:"Phone Number ID"}),e.jsx(h,{id:"phone-number-id",value:re,onChange:a=>ee(a.target.value),placeholder:"123456789"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"whatsapp-business-id",children:"WhatsApp Business ID"}),e.jsx(h,{id:"whatsapp-business-id",value:ne,onChange:a=>t(a.target.value),placeholder:"987654321"})]})]}),e.jsx(q,{value:"integrations",className:"space-y-4",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"reservations-webhook",children:"Webhook R√©servations"}),e.jsx(h,{id:"reservations-webhook",value:u,onChange:a=>j(a.target.value),placeholder:"https://n8n.chatfood.fr/webhook/...",className:"font-mono text-sm"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"üí° URL du webhook n8n pour les notifications de r√©servations"})]})})}),e.jsx(q,{value:"prompt",className:"space-y-4",children:e.jsx(fs,{value:R,onChange:S,restaurantName:y.restaurantName,openingHours:y.openingHours,categories:y.categories,assets:y.assets,address:y.address,orderWaitTime:y.orderWaitTime,defaultTemplate:w})})]})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(O,{onClick:Le,disabled:L,className:"w-full sm:w-auto",children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),L?"Enregistrement...":"Enregistrer tous les param√®tres"]})})]})]})}const vs={phone_number_id:"",waba_id:"",access_token:"",display_phone_number:"",verified_name:"",status:"active",registration_status:"pending",business_id:"",source:"manual"};function at(){const p=Be(),[m,d]=n.useState([]),[l,Q]=n.useState(""),[L,z]=n.useState(!0),[T,x]=n.useState(!1),[F,Z]=n.useState(!1),[G,C]=n.useState(!1),[W,P]=n.useState(!1),[i,r]=n.useState(!1),[D,M]=n.useState(!1),[s,v]=n.useState(null),[R,S]=n.useState(null),[g,k]=n.useState(!1);n.useEffect(()=>{V()},[]),n.useEffect(()=>{l?E():(v(null),S(null),k(!1))},[l]);const V=async()=>{try{z(!0);const{data:t,error:u}=await f.from("profiles").select("user_id, email, first_name, last_name").order("email",{ascending:!0});if(u)throw u;d(t||[])}catch(t){console.error("Error fetching users:",t),A.error("Erreur lors du chargement des utilisateurs")}finally{z(!1)}},E=async()=>{if(l){M(!0),k(!1);try{const[t,u]=await Promise.all([f.from("whatsapp_integrations").select("*").eq("user_id",l).order("updated_at",{ascending:!1}).maybeSingle(),f.from("restaurant_settings").select("phone_number_id, whatsapp_access_token, whatsapp_business_id").eq("user_id",l).maybeSingle()]),j=t.data,w=u.data;if(j){const B={phone_number_id:j.phone_number_id||"",waba_id:j.waba_id||"",access_token:j.access_token||"",display_phone_number:j.display_phone_number||"",verified_name:j.verified_name||"",status:j.status||"pending",registration_status:j.registration_status||"pending",business_id:j.business_id||"",source:"integration"};v(B),S(B)}else if(w!=null&&w.phone_number_id||w!=null&&w.whatsapp_access_token){const B={phone_number_id:w.phone_number_id||"",waba_id:"",access_token:w.whatsapp_access_token||"",display_phone_number:"",verified_name:"",status:"active",registration_status:"registered",business_id:w.whatsapp_business_id||"",source:"settings"};v(B),S(B)}else v(null),S(null)}catch(t){console.error("Error fetching WhatsApp data:",t),A.error("Erreur lors du chargement des donn√©es WhatsApp")}finally{M(!1)}}},J=t=>t.first_name&&t.last_name?`${t.first_name} ${t.last_name} (${t.email})`:t.email,X=()=>{v({...vs}),S(null),k(!0)},N=(t,u)=>{s&&v({...s,[t]:u})},ae=()=>s?g||!R?!0:JSON.stringify(s)!==JSON.stringify(R):!1,K=async()=>{if(!(!l||!s)){C(!0);try{if(g||(R==null?void 0:R.source)==="settings"){const{data:t}=await f.from("whatsapp_integrations").select("id").eq("user_id",l).maybeSingle();t?await f.from("whatsapp_integrations").update({phone_number_id:s.phone_number_id,waba_id:s.waba_id||s.phone_number_id,access_token:s.access_token,display_phone_number:s.display_phone_number||null,verified_name:s.verified_name||null,status:s.status,registration_status:s.registration_status,business_id:s.business_id||null,updated_at:new Date().toISOString()}).eq("user_id",l):await f.from("whatsapp_integrations").insert({user_id:l,phone_number_id:s.phone_number_id,waba_id:s.waba_id||s.phone_number_id,access_token:s.access_token,display_phone_number:s.display_phone_number||null,verified_name:s.verified_name||null,status:s.status,registration_status:s.registration_status,business_id:s.business_id||null})}else await f.from("whatsapp_integrations").update({phone_number_id:s.phone_number_id,waba_id:s.waba_id,access_token:s.access_token,display_phone_number:s.display_phone_number||null,verified_name:s.verified_name||null,status:s.status,registration_status:s.registration_status,business_id:s.business_id||null,updated_at:new Date().toISOString()}).eq("user_id",l);await f.from("restaurant_settings").update({phone_number_id:s.phone_number_id,whatsapp_access_token:s.access_token,whatsapp_business_id:s.business_id||null,chatbot_active:s.status==="active"}).eq("user_id",l),A.success("Donn√©es WhatsApp enregistr√©es"),k(!1),await E()}catch(t){console.error("Error saving WhatsApp data:",t),A.error(t.message||"Erreur lors de l'enregistrement")}finally{C(!1)}}},ue=async()=>{if(l){x(!0);try{const{data:{session:t}}=await f.auth.getSession();if(!t){A.error("Session expir√©e");return}const{data:u,error:j}=await f.functions.invoke("admin-register-whatsapp",{body:{user_id:l},headers:{Authorization:`Bearer ${t.access_token}`}});if(j)throw j;u!=null&&u.success?(A.success(u.message||"Num√©ro WhatsApp enregistr√© avec succ√®s"),await E()):u!=null&&u.error&&A.error(u.error)}catch(t){console.error("Error re-registering WhatsApp:",t),A.error(t.message||"Erreur lors de l'enregistrement")}finally{x(!1)}}},re=async()=>{if(l){P(!0);try{await f.from("whatsapp_integrations").update({status:"inactive"}).eq("user_id",l),await f.from("restaurant_settings").update({chatbot_active:!1}).eq("user_id",l),A.success("WhatsApp d√©connect√©"),await p.refetchQueries({queryKey:["whatsapp-integration",l]}),s&&(v({...s,status:"inactive"}),S({...s,status:"inactive"})),await E()}catch{A.error("Erreur lors de la d√©connexion")}finally{P(!1)}}},ee=async()=>{if(!(!l||!window.confirm(`√ätes-vous s√ªr de vouloir supprimer TOUTES les donn√©es WhatsApp de cet utilisateur ?

Cette action est irr√©versible et supprimera :
- L'int√©gration WhatsApp
- Les tokens et IDs associ√©s`))){r(!0);try{await f.from("whatsapp_integrations").delete().eq("user_id",l),await f.from("restaurant_settings").update({chatbot_active:!1,phone_number_id:null,whatsapp_access_token:null,whatsapp_business_id:null}).eq("user_id",l),A.success("Donn√©es WhatsApp supprim√©es"),await p.refetchQueries({queryKey:["whatsapp-integration",l]}),v(null),S(null),k(!1)}catch(u){console.error("Error deleting WhatsApp:",u),A.error("Erreur lors de la suppression")}finally{r(!1)}}},ne=()=>{k(!1),E()};return L?e.jsx("div",{className:"container mx-auto p-6 space-y-6",children:e.jsxs($,{children:[e.jsxs(ce,{children:[e.jsx(I,{className:"h-8 w-64"}),e.jsx(I,{className:"h-4 w-96"})]}),e.jsx(de,{children:e.jsx(I,{className:"h-10 w-full"})})]})}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(He,{className:"h-8 w-8 text-primary"}),"Param√®tres Techniques Restaurant"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"G√©rez les param√®tres techniques WhatsApp pour chaque utilisateur"})]}),e.jsxs($,{children:[e.jsxs(ce,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5"}),"S√©lectionner un utilisateur"]}),e.jsx(Te,{children:"Choisissez l'utilisateur pour lequel vous souhaitez modifier les param√®tres techniques"})]}),e.jsxs(de,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"user-select",children:"Utilisateur"}),e.jsxs(pe,{value:l,onValueChange:Q,children:[e.jsx(he,{id:"user-select",children:e.jsx(xe,{placeholder:"S√©lectionnez un utilisateur..."})}),e.jsx(ge,{children:m.map(t=>e.jsx(H,{value:t.user_id,children:J(t)},t.user_id))})]})]}),!l&&e.jsx(_e,{children:e.jsx(be,{children:"S√©lectionnez un utilisateur pour afficher et modifier ses param√®tres techniques."})}),l&&e.jsxs("div",{className:"pt-4 border-t space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"h-5 w-5 text-green-600"}),e.jsx("span",{className:"font-medium",children:"Int√©gration WhatsApp"}),s&&!g&&e.jsxs(e.Fragment,{children:[e.jsx(te,{variant:s.status==="active"?"default":"secondary",children:s.status}),s.source==="settings"&&e.jsx(te,{variant:"outline",className:"text-amber-600 border-amber-600",children:"Donn√©es partielles (restaurant_settings)"})]}),g&&e.jsx(te,{variant:"outline",className:"text-blue-600 border-blue-600",children:"Cr√©ation manuelle"})]})}),D?e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{className:"h-10 w-full"}),e.jsx(I,{className:"h-10 w-full"})]}):s||g?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Phone Number ID *"}),e.jsx(h,{value:(s==null?void 0:s.phone_number_id)||"",onChange:t=>N("phone_number_id",t.target.value),className:"text-xs font-mono",placeholder:"123456789..."})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"WABA ID"}),e.jsx(h,{value:(s==null?void 0:s.waba_id)||"",onChange:t=>N("waba_id",t.target.value),className:"text-xs font-mono",placeholder:"123456789..."})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Num√©ro affich√©"}),e.jsx(h,{value:(s==null?void 0:s.display_phone_number)||"",onChange:t=>N("display_phone_number",t.target.value),className:"text-xs",placeholder:"+33 6 12 34 56 78"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Nom v√©rifi√©"}),e.jsx(h,{value:(s==null?void 0:s.verified_name)||"",onChange:t=>N("verified_name",t.target.value),className:"text-xs",placeholder:"Mon Restaurant"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Business ID"}),e.jsx(h,{value:(s==null?void 0:s.business_id)||"",onChange:t=>N("business_id",t.target.value),className:"text-xs font-mono",placeholder:"123456789..."})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Access Token *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:F?"text":"password",value:(s==null?void 0:s.access_token)||"",onChange:t=>N("access_token",t.target.value),className:"text-xs font-mono",placeholder:"EAAxxxxxxx..."}),e.jsx(O,{variant:"outline",size:"icon",onClick:()=>Z(!F),children:F?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Ie,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Statut"}),e.jsxs(pe,{value:(s==null?void 0:s.status)||"pending",onValueChange:t=>N("status",t),children:[e.jsx(he,{className:"text-xs",children:e.jsx(xe,{})}),e.jsxs(ge,{children:[e.jsx(H,{value:"active",children:"active"}),e.jsx(H,{value:"inactive",children:"inactive"}),e.jsx(H,{value:"pending",children:"pending"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs text-muted-foreground",children:"Statut enregistrement"}),e.jsxs(pe,{value:(s==null?void 0:s.registration_status)||"pending",onValueChange:t=>N("registration_status",t),children:[e.jsx(he,{className:"text-xs",children:e.jsx(xe,{})}),e.jsxs(ge,{children:[e.jsx(H,{value:"registered",children:"registered"}),e.jsx(H,{value:"pending",children:"pending"}),e.jsx(H,{value:"failed",children:"failed"})]})]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2 flex-wrap",children:[e.jsxs(O,{onClick:K,disabled:G||!ae(),size:"sm",children:[G?e.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(De,{className:"h-4 w-4 mr-2"}),"Enregistrer tout"]}),g&&e.jsx(O,{variant:"outline",size:"sm",onClick:ne,children:"Annuler"}),!g&&s&&e.jsxs(e.Fragment,{children:[s.status==="active"?e.jsxs(O,{variant:"destructive",size:"sm",onClick:re,disabled:W,children:[W?e.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(xs,{className:"h-4 w-4 mr-2"}),"D√©connecter"]}):e.jsx(ve,{existingIntegration:{waba_id:s.waba_id,phone_number_id:s.phone_number_id,status:s.status,display_phone_number:s.display_phone_number||null,verified_name:s.verified_name||null},onSuccess:()=>E()}),e.jsxs(O,{variant:"outline",size:"sm",onClick:ue,disabled:T,children:[T?e.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(gs,{className:"h-4 w-4 mr-2"}),"R√©-enregistrer"]}),e.jsxs(O,{variant:"ghost",size:"sm",onClick:ee,disabled:i,className:"text-destructive hover:text-destructive hover:bg-destructive/10",children:[i?e.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(We,{className:"h-4 w-4 mr-2"}),"Supprimer tout"]})]})]})]}):e.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[e.jsx("p",{className:"mb-3 text-sm",children:"Aucune int√©gration WhatsApp pour cet utilisateur"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx(ve,{onSuccess:()=>E()}),e.jsxs(O,{variant:"outline",size:"sm",onClick:X,children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),"Cr√©er manuellement"]})]})]})]})]})]}),l&&e.jsx(bs,{userId:l,isAdminView:!0})]})}export{at as default};
