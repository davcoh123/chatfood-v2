const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min.js","assets/index.js","assets/index.css"])))=>i.map(i=>d[i]);
import{d as F,s as E,_ as R,r as $,m as S}from"./index.js";import{u as j,a as L,b as O,c as q}from"./useSatisfactionAnalytics.js";import{u as M}from"./useQuery.js";import{f as w,b as D}from"./fr.js";const A=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899","#06B6D4","#F97316","#14B8A6","#6366F1","#84CC16","#D946EF","#0EA5E9","#22C55E","#A855F7"];function z(){const{user:e}=F(),{data:y,isLoading:a}=M({queryKey:["products-analytics-orders",e==null?void 0:e.id],queryFn:async()=>{if(!(e!=null&&e.id))return[];const{data:o,error:r}=await E.from("chatbot_orders").select("id, commande_item, status").eq("user_id",e.id).in("status",["delivered","ready","preparing","confirmed"]);if(r)throw r;return o||[]},enabled:!!(e!=null&&e.id)}),{data:i}=M({queryKey:["products-list",e==null?void 0:e.id],queryFn:async()=>{if(!(e!=null&&e.id))return[];const{data:o,error:r}=await E.from("products").select("id, name, category, unit_price").eq("user_id",e.id);if(r)throw r;return o||[]},enabled:!!(e!=null&&e.id)}),t={};y==null||y.forEach(o=>{const r=o.commande_item;Array.isArray(r)&&r.forEach(m=>{const l=i==null?void 0:i.find(_=>_.id===m.product_id||_.name===m.name),p=m.name||(l==null?void 0:l.name)||"Produit inconnu",v=m.category||(l==null?void 0:l.category);if(!v)return;const f=m.quantity||1,C=(m.unit_price||m.price||(l==null?void 0:l.unit_price)||0)*f;t[p]||(t[p]={sales:0,revenue:0,category:v}),t[p].sales+=f,t[p].revenue+=C})});const g=Object.values(t).reduce((o,r)=>o+r.sales,0)||1,d=Object.entries(t).map(([o,r])=>({name:o,sales:r.sales,revenue:Math.round(r.revenue),category:r.category,percentage:Math.round(r.sales/g*100*10)/10})).sort((o,r)=>r.sales-o.sales).slice(0,10),n=d[0]||{name:"N/A",sales:0,revenue:0,category:"N/A",percentage:0},u={};Object.values(t).forEach(o=>{u[o.category]||(u[o.category]={sales:0,revenue:0}),u[o.category].sales+=o.sales,u[o.category].revenue+=o.revenue});const c=Object.entries(u).map(([o,r])=>({category:o,sales:r.sales,revenue:Math.round(r.revenue)})).sort((o,r)=>r.sales-o.sales),h={};return c.forEach((o,r)=>{h[o.category]=A[r%A.length]}),{isLoading:a,topProducts:d,topProduct:n,salesByCategory:c,totalSales:g,categoryColors:h}}async function H(e,y){const{default:a}=await R(async()=>{const{default:c}=await import("./jspdf.es.min.js").then(h=>h.j);return{default:c}},__vite__mapDeps([0,1,2])),{default:i}=await R(async()=>{const{default:c}=await import("./jspdf.plugin.autotable.js");return{default:c}},[]),t=new a,g=t.internal.pageSize.getWidth(),d=w(new Date,"dd/MM/yyyy HH:mm",{locale:D});t.setFontSize(20),t.setTextColor(40,40,40),t.text("Rapport Analytics",14,22),t.setFontSize(14),t.setTextColor(100,100,100),t.text(y,14,30),t.setFontSize(10),t.text(`GÃ©nÃ©rÃ© le ${d}`,14,38),t.setDrawColor(200,200,200),t.line(14,42,g-14,42);let n=50;t.setFontSize(14),t.setTextColor(40,40,40),t.text("ðŸ“Š Revenus",14,n),n+=8,i(t,{startY:n,head:[["MÃ©trique","Valeur"]],body:[["Revenu ce mois",`â‚¬${e.revenue.thisMonth.toLocaleString("fr-FR")}`],["Revenu mois dernier",`â‚¬${e.revenue.lastMonth.toLocaleString("fr-FR")}`],["Croissance",`${e.revenue.growth>=0?"+":""}${e.revenue.growth}%`],["Revenu hebdomadaire moyen",`â‚¬${e.revenue.weeklyAverage.toLocaleString("fr-FR")}`]],theme:"striped",headStyles:{fillColor:[59,130,246]},margin:{left:14,right:14}}),n=t.lastAutoTable.finalY+15,t.setFontSize(14),t.text("ðŸ›’ Commandes",14,n),n+=8,i(t,{startY:n,head:[["MÃ©trique","Valeur"]],body:[["Commandes ce mois",e.orders.thisMonth.toString()],["Croissance",`${e.orders.growth>=0?"+":""}${e.orders.growth}%`],["Jour de pointe",e.orders.peakDay],["Heure de pointe",e.orders.peakHour]],theme:"striped",headStyles:{fillColor:[16,185,129]},margin:{left:14,right:14}}),n=t.lastAutoTable.finalY+15,t.setFontSize(14),t.text("ðŸ‘¥ Clients",14,n),n+=8,i(t,{startY:n,head:[["MÃ©trique","Valeur"]],body:[["Clients totaux",e.customers.total.toString()],["Clients actifs (30j)",e.customers.active.toString()],["Taux de rÃ©tention",`${e.customers.retentionRate}%`],["Nouveaux ce mois",e.customers.newThisMonth.toString()]],theme:"striped",headStyles:{fillColor:[139,92,246]},margin:{left:14,right:14}}),n=t.lastAutoTable.finalY+15,n>220&&(t.addPage(),n=20),t.setFontSize(14),t.text("â­ Top 5 Produits",14,n),n+=8,i(t,{startY:n,head:[["Produit","Ventes","Revenu","CatÃ©gorie"]],body:e.products.top.slice(0,5).map(c=>[c.name,c.sales.toString(),`â‚¬${c.revenue.toLocaleString("fr-FR")}`,c.category]),theme:"striped",headStyles:{fillColor:[249,115,22]},margin:{left:14,right:14}}),n=t.lastAutoTable.finalY+15,t.setFontSize(14),t.text("ðŸ˜Š Satisfaction Client",14,n),n+=8,i(t,{startY:n,head:[["MÃ©trique","Valeur"]],body:[["Note moyenne",`${e.satisfaction.averageRating}/5`],["Nombre d'avis",e.satisfaction.totalReviews.toString()]],theme:"striped",headStyles:{fillColor:[236,72,153]},margin:{left:14,right:14}});const u=t.getNumberOfPages();for(let c=1;c<=u;c++)t.setPage(c),t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Page ${c} sur ${u}`,g/2,t.internal.pageSize.getHeight()-10,{align:"center"});t.save(`analytics-${w(new Date,"yyyy-MM-dd")}.pdf`)}async function B(e,y){const a=await R(()=>import("./xlsx.js"),[]),i=a.utils.book_new(),t=w(new Date,"dd/MM/yyyy HH:mm",{locale:D}),g=[["Rapport Analytics",y],["GÃ©nÃ©rÃ© le",t],[""],["=== REVENUS ==="],["Revenu ce mois",e.revenue.thisMonth],["Revenu mois dernier",e.revenue.lastMonth],["Croissance (%)",e.revenue.growth],["Revenu hebdomadaire moyen",e.revenue.weeklyAverage],[""],["=== COMMANDES ==="],["Commandes ce mois",e.orders.thisMonth],["Croissance (%)",e.orders.growth],["Jour de pointe",e.orders.peakDay],["Heure de pointe",e.orders.peakHour],[""],["=== CLIENTS ==="],["Clients totaux",e.customers.total],["Clients actifs (30j)",e.customers.active],["Taux de rÃ©tention (%)",e.customers.retentionRate],["Nouveaux ce mois",e.customers.newThisMonth],[""],["=== SATISFACTION ==="],["Note moyenne",e.satisfaction.averageRating],["Nombre d'avis",e.satisfaction.totalReviews]],d=a.utils.aoa_to_sheet(g);d["!cols"]=[{wch:25},{wch:20}],a.utils.book_append_sheet(i,d,"RÃ©sumÃ©");const n=a.utils.json_to_sheet(e.revenue.weekly);a.utils.book_append_sheet(i,n,"Revenus Hebdo");const u=a.utils.json_to_sheet(e.revenue.byCategory);a.utils.book_append_sheet(i,u,"Revenus CatÃ©gories");const c=a.utils.json_to_sheet(e.orders.byDay);a.utils.book_append_sheet(i,c,"Commandes par Jour");const h=a.utils.json_to_sheet(e.products.top);a.utils.book_append_sheet(i,h,"Top Produits");const o=a.utils.json_to_sheet(e.customers.segments);a.utils.book_append_sheet(i,o,"Segments Clients");const r=a.utils.json_to_sheet(e.satisfaction.distribution);a.utils.book_append_sheet(i,r,"Distribution Notes"),a.writeFile(i,`analytics-${w(new Date,"yyyy-MM-dd")}.xlsx`)}function K(){const{profile:e}=F(),[y,a]=$.useState(!1),{revenueThisMonth:i,revenueLastMonth:t,growthPercentage:g,averageWeeklyRevenue:d,weeklyRevenue:n,revenueByCategory:u}=j(),{ordersThisMonth:c,ordersGrowth:h,ordersByDayOfWeek:o,peakDay:r,peakHour:m}=L(),{totalCustomers:l,activeCustomers:p,retentionRate:v,newCustomersThisMonth:f,segments:C}=O(),{topProducts:_,totalSales:P}=z(),{averageRating:T,totalReviews:k,ratingsDistribution:N}=q(),x=()=>({revenue:{thisMonth:i,lastMonth:t,growth:g,weeklyAverage:d,weekly:n.map(s=>({week:s.week,revenue:s.revenue,orders:s.orders})),byCategory:u.map(s=>({name:s.name,revenue:s.revenue,percentage:s.percentage}))},orders:{thisMonth:c,growth:h,byDay:o.map(s=>({day:s.day,orders:s.orders,percentage:s.percentage})),peakDay:r,peakHour:m},customers:{total:l,active:p,retentionRate:v,newThisMonth:f,segments:C.map(s=>({type:s.type==="vip"?"VIP":s.type==="regular"?"RÃ©gulier":"Nouveau",count:s.count,averageSpend:s.averageSpend,revenuePercentage:s.percentageOfRevenue}))},products:{top:_.map(s=>({name:s.name,sales:s.sales,revenue:s.revenue,category:s.category})),totalSales:P},satisfaction:{averageRating:T,totalReviews:k,distribution:N.map(s=>({rating:s.rating,count:s.count,percentage:s.percentage}))}});return{exportPDF:async()=>{a(!0);try{const s=x(),b=e!=null&&e.first_name?`Restaurant de ${e.first_name}`:"Mon Restaurant";await H(s,b),S.success("Rapport PDF tÃ©lÃ©chargÃ©")}catch(s){console.error("Error exporting PDF:",s),S.error("Erreur lors de l'export PDF")}finally{a(!1)}},exportExcel:async()=>{a(!0);try{const s=x(),b=e!=null&&e.first_name?`Restaurant de ${e.first_name}`:"Mon Restaurant";await B(s,b),S.success("Rapport Excel tÃ©lÃ©chargÃ©")}catch(s){console.error("Error exporting Excel:",s),S.error("Erreur lors de l'export Excel")}finally{a(!1)}},isExporting:y}}export{K as a,z as u};
