import{s as D,r as u,j as e,B as p,v as V,I as G,X as A,ah as K,e as M,d as B,h as q,aq as J,C,a as y,b as S,g as k,c as w,f as H}from"./index.js";import{S as Q}from"./switch.js";import{L as N}from"./label.js";import{u as W}from"./useRestaurantSettings.js";import{u as F}from"./useQuery.js";import{P as X,I as Y,G as Z}from"./pencil.js";import{L as z}from"./loader-circle.js";import{C as ee}from"./check.js";import{C as se}from"./copy.js";import{E as P}from"./external-link.js";import{C as _}from"./circle-alert.js";import{C as re}from"./circle-check.js";import{u as ae,C as te,a as ne,b as U,D as ie,c as le,S as oe,v as ce,d as de,s as me,K as ue,P as xe,e as he,f as fe}from"./sortable.esm.js";import{U as I}from"./upload.js";import{T as pe}from"./trash-2.js";import{S as R}from"./star.js";import{L as T}from"./list.js";import{E as ge}from"./eye.js";import{S as je}from"./save.js";import"./index5.js";function Ne(s){return F({queryKey:["restaurant-categories",s],queryFn:async()=>{if(!s)return[];const{data:r,error:o}=await D.from("products").select("category").eq("user_id",s).eq("is_active",!0);if(o)throw o;return[...new Set((r==null?void 0:r.map(a=>a.category))||[])].filter(Boolean).sort()},enabled:!!s})}const b=s=>/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(s)&&s.length>=3,ve=s=>s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");function be(s,r){const[o,l]=u.useState(s);u.useEffect(()=>{const t=setTimeout(()=>{l(s)},300);return()=>clearTimeout(t)},[s]);const{data:a,isLoading:n,error:i}=F({queryKey:["slug-availability",o],queryFn:async()=>{if(!b(o))return{isAvailable:!1,reason:"invalid"};const{data:t,error:c}=await D.from("restaurant_settings").select("user_id").eq("slug",o).neq("user_id",r).maybeSingle();if(c)throw c;return{isAvailable:!t,reason:t?"taken":"available"}},enabled:o.length>=3&&b(o),staleTime:1e4,refetchOnWindowFocus:!1});return{isAvailable:(a==null?void 0:a.isAvailable)??!1,reason:(a==null?void 0:a.reason)??(s.length<3?"too-short":b(s)?void 0:"invalid"),isChecking:n||o!==s,error:i}}function Ce({currentSlug:s,userId:r,onSave:o,isSaving:l}){const[a,n]=u.useState(!1),[i,t]=u.useState(s),{isAvailable:c,isChecking:m}=be(i,r),x="https://chatfood.fr/r/",d=i!==s,f=d&&c&&b(i)&&!m;u.useEffect(()=>{a||t(s)},[s,a]);const g=h=>{const $=ve(h);t($)},v=()=>{f&&(o(i),n(!1))},E=()=>{t(s),n(!1)},L=()=>{navigator.clipboard.writeText(`${x}${s}`),K({title:"Lien copié !"})},O=()=>d?m?e.jsx(z,{className:"h-4 w-4 animate-spin text-muted-foreground"}):i.length<3?e.jsx(_,{className:"h-4 w-4 text-amber-500"}):b(i)?c?e.jsx(re,{className:"h-4 w-4 text-green-500"}):e.jsx(A,{className:"h-4 w-4 text-destructive"}):e.jsx(_,{className:"h-4 w-4 text-destructive"}):null,j=()=>d?m?e.jsx("span",{className:"text-muted-foreground",children:"Vérification..."}):i.length<3?e.jsx("span",{className:"text-amber-500",children:"Minimum 3 caractères"}):b(i)?c?e.jsx("span",{className:"text-green-500",children:"Cette URL est disponible"}):e.jsx("span",{className:"text-destructive",children:"Cette URL est déjà utilisée"}):e.jsx("span",{className:"text-destructive",children:"Format invalide (lettres, chiffres, tirets)"}):null;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{className:"text-base font-medium",children:"Votre URL publique"}),!a&&e.jsxs(p,{variant:"ghost",size:"sm",onClick:()=>n(!0),className:"h-8 px-2",children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Modifier"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:V("flex items-center flex-1 rounded-lg border bg-background overflow-hidden",a&&"ring-2 ring-primary/20 border-primary/50"),children:[e.jsx("span",{className:"px-3 py-2 bg-muted text-muted-foreground text-sm font-mono border-r shrink-0",children:x}),a?e.jsxs("div",{className:"flex items-center flex-1 gap-2 pr-2",children:[e.jsx(G,{value:i,onChange:h=>g(h.target.value),className:"border-0 shadow-none focus-visible:ring-0 font-mono text-sm",placeholder:"mon-restaurant",autoFocus:!0}),O()]}):e.jsx("span",{className:"px-3 py-2 font-mono text-sm flex-1",children:s})]}),a?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(p,{variant:"ghost",size:"icon",onClick:E,className:"h-10 w-10",children:e.jsx(A,{className:"h-4 w-4"})}),e.jsx(p,{size:"icon",onClick:v,disabled:!f||l,className:"h-10 w-10",children:l?e.jsx(z,{className:"h-4 w-4 animate-spin"}):e.jsx(ee,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"flex gap-1",children:[e.jsx(p,{variant:"outline",size:"icon",onClick:L,className:"h-10 w-10",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx(p,{variant:"outline",size:"icon",asChild:!0,className:"h-10 w-10",children:e.jsx("a",{href:`https://chatfood.fr/r/${s}`,target:"_blank",rel:"noopener noreferrer",children:e.jsx(P,{className:"h-4 w-4"})})})]})]}),a&&e.jsx("div",{className:"flex items-center gap-2 text-sm",children:j()})]})}function we({userId:s,currentImageUrl:r,onImageChange:o,isUpdating:l=!1}){const a=u.useRef(null),{uploadAsset:n,deleteAsset:i,uploading:t}=ae(s),c=async d=>{var v;const f=(v=d.target.files)==null?void 0:v[0];if(!f)return;const g=await n(f,"Photo de couverture");g&&o(g.url),a.current&&(a.current.value="")},m=async()=>{r&&(await i(r),o(null))},x=t||l;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs(N,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"Photo de couverture"]}),r?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"relative rounded-lg overflow-hidden h-40 bg-muted border",children:e.jsx("img",{src:r,alt:"Photo de couverture",className:"w-full h-full object-cover",onError:d=>{d.currentTarget.style.display="none"}})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:()=>{var d;return(d=a.current)==null?void 0:d.click()},disabled:x,children:[t?e.jsx(z,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(I,{className:"h-4 w-4 mr-2"}),"Changer l'image"]}),e.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:m,disabled:x,className:"text-destructive hover:text-destructive",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Supprimer"]})]})]}):e.jsx("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors",onClick:()=>{var d;return(d=a.current)==null?void 0:d.click()},children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t?e.jsx(z,{className:"h-8 w-8 text-muted-foreground animate-spin"}):e.jsx(I,{className:"h-8 w-8 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?"Upload en cours...":"Cliquez pour ajouter une photo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Taille recommandée : 1200×630 pixels"})]})}),e.jsx("input",{ref:a,type:"file",accept:"image/*",onChange:c,className:"hidden"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cette image apparaît en haut de votre page et lors du partage sur les réseaux sociaux."})]})}function ye({categories:s,selectedCategories:r,onSelectionChange:o,maxSelection:l=3}){const a=n=>{r.includes(n)?o(r.filter(i=>i!==n)):r.length<l&&o([...r,n])};return s.length===0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(N,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Catégories mises en avant"]}),e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-muted/50 rounded-lg text-muted-foreground text-sm",children:[e.jsx(_,{className:"h-4 w-4"}),"Ajoutez des produits à votre catalogue pour voir vos catégories"]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(N,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Catégories mises en avant"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[r.length,"/",l," sélectionnées"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ces catégories apparaissent sous le nom de votre restaurant"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:s.map(n=>{const i=r.includes(n),t=!i&&r.length>=l;return e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${i?"border-primary bg-primary/5":t?"border-muted bg-muted/50 cursor-not-allowed opacity-50":"border-border hover:border-primary/50"}`,children:[e.jsx(te,{checked:i,onCheckedChange:()=>!t&&a(n),disabled:t}),e.jsx("span",{className:"text-sm truncate",children:n})]},n)})}),r.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2",children:r.map(n=>e.jsx(M,{variant:"secondary",className:"text-xs",children:n},n))})]})}function Se({category:s,index:r}){const{attributes:o,listeners:l,setNodeRef:a,transform:n,transition:i,isDragging:t}=he({id:s}),c={transform:fe.Transform.toString(n),transition:i};return e.jsxs("div",{ref:a,style:c,className:`flex items-center gap-3 p-3 rounded-lg border bg-background ${t?"shadow-lg border-primary z-10":"border-border"}`,children:[e.jsx("button",{type:"button",className:"cursor-grab active:cursor-grabbing text-muted-foreground hover:text-foreground",...o,...l,children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-sm text-muted-foreground w-6",children:[r+1,"."]}),e.jsx("span",{className:"text-sm flex-1",children:s})]})}function ke({categories:s,categoryOrder:r,onOrderChange:o}){const[l,a]=u.useState([]);u.useEffect(()=>{const t=r.filter(m=>s.includes(m)),c=s.filter(m=>!r.includes(m));a([...t,...c])},[s,r]);const n=ne(U(xe),U(ue,{coordinateGetter:me})),i=t=>{const{active:c,over:m}=t;if(m&&c.id!==m.id){const x=l.indexOf(c.id),d=l.indexOf(m.id),f=de(l,x,d);a(f),o(f)}};return s.length===0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(N,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"}),"Ordre des catégories"]}),e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-muted/50 rounded-lg text-muted-foreground text-sm",children:[e.jsx(_,{className:"h-4 w-4"}),"Ajoutez des produits à votre catalogue pour organiser vos catégories"]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs(N,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"}),"Ordre des catégories"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Glissez-déposez pour réorganiser l'ordre d'affichage dans le menu"}),e.jsx(ie,{sensors:n,collisionDetection:le,onDragEnd:i,children:e.jsx(oe,{items:l,strategy:ce,children:e.jsx("div",{className:"space-y-2",children:l.map((t,c)=>e.jsx(Se,{category:t,index:c},t))})})})]})}function Je(){const{user:s}=B(),{settings:r,isLoading:o,updateSettings:l,isUpdating:a}=W(),{data:n=[]}=Ne(s==null?void 0:s.id),[i,t]=u.useState(null),[c,m]=u.useState([]),[x,d]=u.useState([]),[f,g]=u.useState(!1);u.useEffect(()=>{r&&(t(r.cover_image_url||null),m(r.featured_categories||[]),d(r.category_order||[]),g(r.online_orders_enabled??!1))},[r]);const v=h=>{l({slug:h})},E=h=>{t(h),l({cover_image_url:h})},L=()=>{l({featured_categories:c.length>0?c:null,category_order:x.length>0?x:null})},O=JSON.stringify(c)!==JSON.stringify((r==null?void 0:r.featured_categories)||[])||JSON.stringify(x)!==JSON.stringify((r==null?void 0:r.category_order)||[]);if(o)return e.jsxs("div",{className:"container mx-auto p-6 max-w-4xl space-y-6",children:[e.jsx(q,{className:"h-10 w-64"}),e.jsx(q,{className:"h-48 w-full"}),e.jsx(q,{className:"h-64 w-full"})]});const j=r!=null&&r.slug?`https://chatfood.fr/r/${r.slug}`:null;return e.jsxs("div",{className:"container mx-auto p-6 max-w-4xl space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(J,{className:"h-6 w-6 text-primary"}),"Votre Profil Public"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Personnalisez comment vos clients voient votre restaurant"})]}),j&&e.jsx(p,{variant:"outline",asChild:!0,children:e.jsxs("a",{href:j,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Voir ma page"]})})]}),e.jsxs(C,{children:[e.jsxs(y,{className:"pb-4",children:[e.jsxs(S,{className:"text-lg flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5"}),"URL publique"]}),e.jsx(k,{children:"L'adresse web que vos clients utilisent pour voir votre menu"})]}),e.jsx(w,{children:(r==null?void 0:r.slug)&&(s==null?void 0:s.id)&&e.jsx(Ce,{currentSlug:r.slug,userId:s.id,onSave:v,isSaving:a})})]}),e.jsxs(C,{children:[e.jsxs(y,{className:"pb-4",children:[e.jsxs(S,{className:"text-lg flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),"Commandes en ligne"]}),e.jsx(k,{children:"Permettre aux clients de commander directement depuis votre page publique"})]}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(N,{htmlFor:"online-orders",className:"font-medium",children:"Activer les commandes en ligne"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Les clients pourront ajouter des produits au panier et passer commande"})]}),e.jsx(Q,{id:"online-orders",checked:f,onCheckedChange:h=>{g(h),l({online_orders_enabled:h})}})]})})]}),e.jsxs(C,{children:[e.jsxs(y,{className:"pb-4",children:[e.jsx(S,{className:"text-lg",children:"Photo de couverture"}),e.jsx(k,{children:"L'image principale affichée en haut de votre page publique"})]}),e.jsx(w,{children:(s==null?void 0:s.id)&&e.jsx(we,{userId:s.id,currentImageUrl:i,onImageChange:E,isUpdating:a})})]}),e.jsxs(C,{children:[e.jsxs(y,{className:"pb-4",children:[e.jsx(S,{className:"text-lg",children:"Personnalisation des catégories"}),e.jsx(k,{children:"Choisissez les catégories mises en avant et leur ordre d'affichage"})]}),e.jsxs(w,{className:"space-y-8",children:[e.jsx(ye,{categories:n,selectedCategories:c,onSelectionChange:m}),e.jsx(ke,{categories:n,categoryOrder:x,onOrderChange:d}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(p,{onClick:L,disabled:!O||a,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),a?"Enregistrement...":"Enregistrer"]})})]})]}),j&&e.jsx(C,{className:"border-dashed bg-muted/30",children:e.jsx(w,{className:"py-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"text-center sm:text-left",children:[e.jsx("p",{className:"font-medium",children:"Votre page publique est prête !"}),e.jsx("p",{className:"text-sm text-muted-foreground font-mono",children:j})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(p,{variant:"outline",asChild:!0,children:e.jsxs("a",{href:j,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Ouvrir"]})})})]})})})]})}export{Je as default};
