import{r as n,af as K,a3 as M,aR as De,aT as Fe,aZ as We,aV as Me,Q as z,j as g,v as V,I as Le,F as Be,B as me,M as Pe,s as Te}from"./index.js";import{S as $e}from"./search.js";import{P as Ke,c as Ve,b as qe}from"./popover.js";import{L as we}from"./loader-circle.js";import{M as Ge}from"./map-pin.js";import{C as he}from"./circle-check-big.js";import{C as Ue}from"./circle-alert.js";var ge=1,ze=.9,He=.8,Je=.17,re=.1,ne=.999,Qe=.9999,Xe=.99,Ye=/[\\\/_+.#"@\[\(\{&]/,Ze=/[\\\/_+.#"@\[\(\{&]/g,et=/[\s-]/,xe=/[\s-]/g;function se(e,a,t,d,s,u,p){if(u===a.length)return s===e.length?ge:Xe;var h=`${s},${u}`;if(p[h]!==void 0)return p[h];for(var w=d.charAt(u),l=t.indexOf(w,s),f=0,v,I,k,j;l>=0;)v=se(e,a,t,d,l+1,u+1,p),v>f&&(l===s?v*=ge:Ye.test(e.charAt(l-1))?(v*=He,k=e.slice(s,l-1).match(Ze),k&&s>0&&(v*=Math.pow(ne,k.length))):et.test(e.charAt(l-1))?(v*=ze,j=e.slice(s,l-1).match(xe),j&&s>0&&(v*=Math.pow(ne,j.length))):(v*=Je,s>0&&(v*=Math.pow(ne,l-s))),e.charAt(l)!==a.charAt(u)&&(v*=Qe)),(v<re&&t.charAt(l-1)===d.charAt(u+1)||d.charAt(u+1)===d.charAt(u)&&t.charAt(l-1)!==d.charAt(u))&&(I=se(e,a,t,d,l+1,u+2,p),I*re>v&&(v=I*re)),v>f&&(f=v),l=t.indexOf(w,l+1);return p[h]=f,f}function ve(e){return e.toLowerCase().replace(xe," ")}function tt(e,a,t){return e=t&&t.length>0?`${e+" "+t.join(" ")}`:e,se(e,a,ve(e),ve(a),0,0,{})}var G='[cmdk-group=""]',ae='[cmdk-group-items=""]',rt='[cmdk-group-heading=""]',ye='[cmdk-item=""]',be=`${ye}:not([aria-disabled="true"])`,oe="cmdk-item-select",T="data-value",nt=(e,a,t)=>tt(e,a,t),ke=n.createContext(void 0),H=()=>n.useContext(ke),Ee=n.createContext(void 0),le=()=>n.useContext(Ee),Ae=n.createContext(void 0),Ce=n.forwardRef((e,a)=>{let t=$(()=>{var r,m;return{search:"",value:(m=(r=e.value)!=null?r:e.defaultValue)!=null?m:"",selectedItemId:void 0,filtered:{count:0,items:new Map,groups:new Set}}}),d=$(()=>new Set),s=$(()=>new Map),u=$(()=>new Map),p=$(()=>new Set),h=Ie(e),{label:w,children:l,value:f,onValueChange:v,filter:I,shouldFilter:k,loop:j,disablePointerSelection:L=!1,vimBindings:i=!0,...c}=e,y=K(),E=K(),F=K(),D=n.useRef(null),A=mt();B(()=>{if(f!==void 0){let r=f.trim();t.current.value=r,S.emit()}},[f]),B(()=>{A(6,ue)},[]);let S=n.useMemo(()=>({subscribe:r=>(p.current.add(r),()=>p.current.delete(r)),snapshot:()=>t.current,setState:(r,m,b)=>{var o,x,C,O;if(!Object.is(t.current[r],m)){if(t.current[r]=m,r==="search")Z(),X(),A(1,Y);else if(r==="value"){if(document.activeElement.hasAttribute("cmdk-input")||document.activeElement.hasAttribute("cmdk-root")){let _=document.getElementById(F);_?_.focus():(o=document.getElementById(y))==null||o.focus()}if(A(7,()=>{var _;t.current.selectedItemId=(_=P())==null?void 0:_.id,S.emit()}),b||A(5,ue),((x=h.current)==null?void 0:x.value)!==void 0){let _=m??"";(O=(C=h.current).onValueChange)==null||O.call(C,_);return}}S.emit()}},emit:()=>{p.current.forEach(r=>r())}}),[]),R=n.useMemo(()=>({value:(r,m,b)=>{var o;m!==((o=u.current.get(r))==null?void 0:o.value)&&(u.current.set(r,{value:m,keywords:b}),t.current.filtered.items.set(r,ie(m,b)),A(2,()=>{X(),S.emit()}))},item:(r,m)=>(d.current.add(r),m&&(s.current.has(m)?s.current.get(m).add(r):s.current.set(m,new Set([r]))),A(3,()=>{Z(),X(),t.current.value||Y(),S.emit()}),()=>{u.current.delete(r),d.current.delete(r),t.current.filtered.items.delete(r);let b=P();A(4,()=>{Z(),(b==null?void 0:b.getAttribute("id"))===r&&Y(),S.emit()})}),group:r=>(s.current.has(r)||s.current.set(r,new Set),()=>{u.current.delete(r),s.current.delete(r)}),filter:()=>h.current.shouldFilter,label:w||e["aria-label"],getDisablePointerSelection:()=>h.current.disablePointerSelection,listId:y,inputId:F,labelId:E,listInnerRef:D}),[]);function ie(r,m){var b,o;let x=(o=(b=h.current)==null?void 0:b.filter)!=null?o:nt;return r?x(r,t.current.search,m):0}function X(){if(!t.current.search||h.current.shouldFilter===!1)return;let r=t.current.filtered.items,m=[];t.current.filtered.groups.forEach(o=>{let x=s.current.get(o),C=0;x.forEach(O=>{let _=r.get(O);C=Math.max(_,C)}),m.push([o,C])});let b=D.current;q().sort((o,x)=>{var C,O;let _=o.getAttribute("id"),J=x.getAttribute("id");return((C=r.get(J))!=null?C:0)-((O=r.get(_))!=null?O:0)}).forEach(o=>{let x=o.closest(ae);x?x.appendChild(o.parentElement===x?o:o.closest(`${ae} > *`)):b.appendChild(o.parentElement===b?o:o.closest(`${ae} > *`))}),m.sort((o,x)=>x[1]-o[1]).forEach(o=>{var x;let C=(x=D.current)==null?void 0:x.querySelector(`${G}[${T}="${encodeURIComponent(o[0])}"]`);C==null||C.parentElement.appendChild(C)})}function Y(){let r=q().find(b=>b.getAttribute("aria-disabled")!=="true"),m=r==null?void 0:r.getAttribute(T);S.setState("value",m||void 0)}function Z(){var r,m,b,o;if(!t.current.search||h.current.shouldFilter===!1){t.current.filtered.count=d.current.size;return}t.current.filtered.groups=new Set;let x=0;for(let C of d.current){let O=(m=(r=u.current.get(C))==null?void 0:r.value)!=null?m:"",_=(o=(b=u.current.get(C))==null?void 0:b.keywords)!=null?o:[],J=ie(O,_);t.current.filtered.items.set(C,J),J>0&&x++}for(let[C,O]of s.current)for(let _ of O)if(t.current.filtered.items.get(_)>0){t.current.filtered.groups.add(C);break}t.current.filtered.count=x}function ue(){var r,m,b;let o=P();o&&(((r=o.parentElement)==null?void 0:r.firstChild)===o&&((b=(m=o.closest(G))==null?void 0:m.querySelector(rt))==null||b.scrollIntoView({block:"nearest"})),o.scrollIntoView({block:"nearest"}))}function P(){var r;return(r=D.current)==null?void 0:r.querySelector(`${ye}[aria-selected="true"]`)}function q(){var r;return Array.from(((r=D.current)==null?void 0:r.querySelectorAll(be))||[])}function ee(r){let m=q()[r];m&&S.setState("value",m.getAttribute(T))}function te(r){var m;let b=P(),o=q(),x=o.findIndex(O=>O===b),C=o[x+r];(m=h.current)!=null&&m.loop&&(C=x+r<0?o[o.length-1]:x+r===o.length?o[0]:o[x+r]),C&&S.setState("value",C.getAttribute(T))}function ce(r){let m=P(),b=m==null?void 0:m.closest(G),o;for(;b&&!o;)b=r>0?pt(b,G):ft(b,G),o=b==null?void 0:b.querySelector(be);o?S.setState("value",o.getAttribute(T)):te(r)}let de=()=>ee(q().length-1),pe=r=>{r.preventDefault(),r.metaKey?de():r.altKey?ce(1):te(1)},fe=r=>{r.preventDefault(),r.metaKey?ee(0):r.altKey?ce(-1):te(-1)};return n.createElement(M.div,{ref:a,tabIndex:-1,...c,"cmdk-root":"",onKeyDown:r=>{var m;(m=c.onKeyDown)==null||m.call(c,r);let b=r.nativeEvent.isComposing||r.keyCode===229;if(!(r.defaultPrevented||b))switch(r.key){case"n":case"j":{i&&r.ctrlKey&&pe(r);break}case"ArrowDown":{pe(r);break}case"p":case"k":{i&&r.ctrlKey&&fe(r);break}case"ArrowUp":{fe(r);break}case"Home":{r.preventDefault(),ee(0);break}case"End":{r.preventDefault(),de();break}case"Enter":{r.preventDefault();let o=P();if(o){let x=new Event(oe);o.dispatchEvent(x)}}}}},n.createElement("label",{"cmdk-label":"",htmlFor:R.inputId,id:R.labelId,style:gt},w),Q(e,r=>n.createElement(Ee.Provider,{value:S},n.createElement(ke.Provider,{value:R},r))))}),at=n.forwardRef((e,a)=>{var t,d;let s=K(),u=n.useRef(null),p=n.useContext(Ae),h=H(),w=Ie(e),l=(d=(t=w.current)==null?void 0:t.forceMount)!=null?d:p==null?void 0:p.forceMount;B(()=>{if(!l)return h.item(s,p==null?void 0:p.id)},[l]);let f=Se(s,u,[e.value,e.children,u],e.keywords),v=le(),I=W(A=>A.value&&A.value===f.current),k=W(A=>l||h.filter()===!1?!0:A.search?A.filtered.items.get(s)>0:!0);n.useEffect(()=>{let A=u.current;if(!(!A||e.disabled))return A.addEventListener(oe,j),()=>A.removeEventListener(oe,j)},[k,e.onSelect,e.disabled]);function j(){var A,S;L(),(S=(A=w.current).onSelect)==null||S.call(A,f.current)}function L(){v.setState("value",f.current,!0)}if(!k)return null;let{disabled:i,value:c,onSelect:y,forceMount:E,keywords:F,...D}=e;return n.createElement(M.div,{ref:z(u,a),...D,id:s,"cmdk-item":"",role:"option","aria-disabled":!!i,"aria-selected":!!I,"data-disabled":!!i,"data-selected":!!I,onPointerMove:i||h.getDisablePointerSelection()?void 0:L,onClick:i?void 0:j},e.children)}),st=n.forwardRef((e,a)=>{let{heading:t,children:d,forceMount:s,...u}=e,p=K(),h=n.useRef(null),w=n.useRef(null),l=K(),f=H(),v=W(k=>s||f.filter()===!1?!0:k.search?k.filtered.groups.has(p):!0);B(()=>f.group(p),[]),Se(p,h,[e.value,e.heading,w]);let I=n.useMemo(()=>({id:p,forceMount:s}),[s]);return n.createElement(M.div,{ref:z(h,a),...u,"cmdk-group":"",role:"presentation",hidden:v?void 0:!0},t&&n.createElement("div",{ref:w,"cmdk-group-heading":"","aria-hidden":!0,id:l},t),Q(e,k=>n.createElement("div",{"cmdk-group-items":"",role:"group","aria-labelledby":t?l:void 0},n.createElement(Ae.Provider,{value:I},k))))}),ot=n.forwardRef((e,a)=>{let{alwaysRender:t,...d}=e,s=n.useRef(null),u=W(p=>!p.search);return!t&&!u?null:n.createElement(M.div,{ref:z(s,a),...d,"cmdk-separator":"",role:"separator"})}),lt=n.forwardRef((e,a)=>{let{onValueChange:t,...d}=e,s=e.value!=null,u=le(),p=W(l=>l.search),h=W(l=>l.selectedItemId),w=H();return n.useEffect(()=>{e.value!=null&&u.setState("search",e.value)},[e.value]),n.createElement(M.input,{ref:a,...d,"cmdk-input":"",autoComplete:"off",autoCorrect:"off",spellCheck:!1,"aria-autocomplete":"list",role:"combobox","aria-expanded":!0,"aria-controls":w.listId,"aria-labelledby":w.labelId,"aria-activedescendant":h,id:w.inputId,type:"text",value:s?e.value:p,onChange:l=>{s||u.setState("search",l.target.value),t==null||t(l.target.value)}})}),it=n.forwardRef((e,a)=>{let{children:t,label:d="Suggestions",...s}=e,u=n.useRef(null),p=n.useRef(null),h=W(l=>l.selectedItemId),w=H();return n.useEffect(()=>{if(p.current&&u.current){let l=p.current,f=u.current,v,I=new ResizeObserver(()=>{v=requestAnimationFrame(()=>{let k=l.offsetHeight;f.style.setProperty("--cmdk-list-height",k.toFixed(1)+"px")})});return I.observe(l),()=>{cancelAnimationFrame(v),I.unobserve(l)}}},[]),n.createElement(M.div,{ref:z(u,a),...s,"cmdk-list":"",role:"listbox",tabIndex:-1,"aria-activedescendant":h,"aria-label":d,id:w.listId},Q(e,l=>n.createElement("div",{ref:z(p,w.listInnerRef),"cmdk-list-sizer":""},l)))}),ut=n.forwardRef((e,a)=>{let{open:t,onOpenChange:d,overlayClassName:s,contentClassName:u,container:p,...h}=e;return n.createElement(De,{open:t,onOpenChange:d},n.createElement(Fe,{container:p},n.createElement(We,{"cmdk-overlay":"",className:s}),n.createElement(Me,{"aria-label":e.label,"cmdk-dialog":"",className:u},n.createElement(Ce,{ref:a,...h}))))}),ct=n.forwardRef((e,a)=>W(t=>t.filtered.count===0)?n.createElement(M.div,{ref:a,...e,"cmdk-empty":"",role:"presentation"}):null),dt=n.forwardRef((e,a)=>{let{progress:t,children:d,label:s="Loading...",...u}=e;return n.createElement(M.div,{ref:a,...u,"cmdk-loading":"",role:"progressbar","aria-valuenow":t,"aria-valuemin":0,"aria-valuemax":100,"aria-label":s},Q(e,p=>n.createElement("div",{"aria-hidden":!0},p)))}),N=Object.assign(Ce,{List:it,Item:at,Input:lt,Group:st,Separator:ot,Dialog:ut,Empty:ct,Loading:dt});function pt(e,a){let t=e.nextElementSibling;for(;t;){if(t.matches(a))return t;t=t.nextElementSibling}}function ft(e,a){let t=e.previousElementSibling;for(;t;){if(t.matches(a))return t;t=t.previousElementSibling}}function Ie(e){let a=n.useRef(e);return B(()=>{a.current=e}),a}var B=typeof window>"u"?n.useEffect:n.useLayoutEffect;function $(e){let a=n.useRef();return a.current===void 0&&(a.current=e()),a}function W(e){let a=le(),t=()=>e(a.snapshot());return n.useSyncExternalStore(a.subscribe,t,t)}function Se(e,a,t,d=[]){let s=n.useRef(),u=H();return B(()=>{var p;let h=(()=>{var l;for(let f of t){if(typeof f=="string")return f.trim();if(typeof f=="object"&&"current"in f)return f.current?(l=f.current.textContent)==null?void 0:l.trim():s.current}})(),w=d.map(l=>l.trim());u.value(e,h,w),(p=a.current)==null||p.setAttribute(T,h),s.current=h}),s}var mt=()=>{let[e,a]=n.useState(),t=$(()=>new Map);return B(()=>{t.current.forEach(d=>d()),t.current=new Map},[e]),(d,s)=>{t.current.set(d,s),a({})}};function ht(e){let a=e.type;return typeof a=="function"?a(e.props):"render"in a?a.render(e.props):e}function Q({asChild:e,children:a},t){return e&&n.isValidElement(a)?n.cloneElement(ht(a),{ref:a.ref},t(a.props.children)):t(a)}var gt={position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"};const Re=n.forwardRef(({className:e,...a},t)=>g.jsx(N,{ref:t,className:V("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",e),...a}));Re.displayName=N.displayName;const vt=n.forwardRef(({className:e,...a},t)=>g.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[g.jsx($e,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),g.jsx(N.Input,{ref:t,className:V("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",e),...a})]}));vt.displayName=N.Input.displayName;const _e=n.forwardRef(({className:e,...a},t)=>g.jsx(N.List,{ref:t,className:V("max-h-[300px] overflow-y-auto overflow-x-hidden",e),...a}));_e.displayName=N.List.displayName;const Ne=n.forwardRef((e,a)=>g.jsx(N.Empty,{ref:a,className:"py-6 text-center text-sm",...e}));Ne.displayName=N.Empty.displayName;const je=n.forwardRef(({className:e,...a},t)=>g.jsx(N.Group,{ref:t,className:V("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",e),...a}));je.displayName=N.Group.displayName;const bt=n.forwardRef(({className:e,...a},t)=>g.jsx(N.Separator,{ref:t,className:V("-mx-1 h-px bg-border",e),...a}));bt.displayName=N.Separator.displayName;const Oe=n.forwardRef(({className:e,...a},t)=>g.jsx(N.Item,{ref:t,className:V("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",e),...a}));Oe.displayName=N.Item.displayName;function St({value:e,onChange:a,onAddressSelect:t,placeholder:d="Ex: 12 rue de la Paix",id:s}){const[u,p]=n.useState([]),[h,w]=n.useState(!1),[l,f]=n.useState(!1),[v,I]=n.useState(!1),k=n.useRef(null),j=n.useRef(null);n.useEffect(()=>{if(k.current&&clearTimeout(k.current),!e||e.length<3||!v){p([]),f(!1);return}return k.current=setTimeout(async()=>{w(!0);try{const c=await(await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(e)}&limit=5`)).json();if(c.features&&c.features.length>0){const y=c.features.map(E=>({label:E.properties.label,street:E.properties.name,postcode:E.properties.postcode,city:E.properties.city,longitude:E.geometry.coordinates[0],latitude:E.geometry.coordinates[1]}));p(y),f(!0)}else p([]),f(!1)}catch(i){console.error("Error fetching address suggestions:",i),p([])}finally{w(!1)}},300),()=>{k.current&&clearTimeout(k.current)}},[e]);const L=i=>{I(!1),f(!1),p([]),t({street:i.street,postalCode:i.postcode,city:i.city,longitude:i.longitude,latitude:i.latitude})};return g.jsxs(Ke,{open:l,onOpenChange:f,children:[g.jsx(Ve,{asChild:!0,children:g.jsxs("div",{className:"relative",children:[g.jsx(Le,{ref:j,id:s,value:e,onChange:i=>{I(!0),a(i.target.value)},onFocus:()=>I(!0),placeholder:d,autoComplete:"off"}),h&&g.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:g.jsx(we,{className:"h-4 w-4 animate-spin text-muted-foreground"})})]})}),g.jsx(qe,{className:"w-[var(--radix-popover-trigger-width)] p-0",align:"start",onOpenAutoFocus:i=>i.preventDefault(),children:g.jsx(Re,{children:g.jsxs(_e,{children:[g.jsx(Ne,{children:"Aucune adresse trouvée"}),g.jsx(je,{children:u.map((i,c)=>g.jsxs(Oe,{value:i.label,onSelect:()=>L(i),className:"cursor-pointer",children:[g.jsx(Ge,{className:"mr-2 h-4 w-4 text-muted-foreground shrink-0"}),g.jsx("span",{className:"truncate",children:i.label})]},c))})]})})})]})}const U={APP_ID:"793709276646237",CONFIG_ID:"1741873360550446",API_VERSION:"v24.0",SDK_URL:"https://connect.facebook.net/en_US/sdk.js"},wt=6e4;function Rt({existingIntegration:e,onSuccess:a,onError:t}){const{toast:d}=Be(),[s,u]=n.useState(!1),[p,h]=n.useState(!1),[w,l]=n.useState("idle"),f=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{e&&e.status==="active"&&l("success")},[e]),n.useEffect(()=>()=>{f.current&&clearTimeout(f.current)},[]),n.useEffect(()=>{if(document.getElementById("facebook-jssdk")){console.log("[WhatsApp Onboarding] SDK déjà présent dans le DOM"),window.FB&&u(!0);return}window.fbAsyncInit=()=>{window.FB.init({appId:U.APP_ID,cookie:!0,autoLogAppEvents:!0,xfbml:!0,version:U.API_VERSION}),window.FB.AppEvents.logPageView(),console.log("[WhatsApp Onboarding] SDK Facebook initialisé avec succès"),u(!0)};const i=document.createElement("script");i.id="facebook-jssdk",i.src=U.SDK_URL,i.async=!0,i.defer=!0,i.crossOrigin="anonymous";const c=document.getElementsByTagName("script")[0];c&&c.parentNode?c.parentNode.insertBefore(i,c):document.head.appendChild(i),console.log("[WhatsApp Onboarding] Script SDK Facebook ajouté au DOM")},[]),n.useEffect(()=>{const i=c=>{var y,E,F,D,A,S;if(c.origin.endsWith("facebook.com")){console.log("[WhatsApp Onboarding] Message reçu de Facebook:",c.origin);try{const R=typeof c.data=="string"?JSON.parse(c.data):c.data;R.type==="WA_EMBEDDED_SIGNUP"&&(f.current&&(clearTimeout(f.current),f.current=null),R.event==="FINISH"?(console.log("[WhatsApp Onboarding] Signup terminé:",{phone_number_id:(y=R.data)==null?void 0:y.phone_number_id,waba_id:(E=R.data)==null?void 0:E.waba_id,business_id:(F=R.data)==null?void 0:F.business_id}),v.current={phone_number_id:((D=R.data)==null?void 0:D.phone_number_id)||"",waba_id:((A=R.data)==null?void 0:A.waba_id)||"",business_id:(S=R.data)==null?void 0:S.business_id},console.log("[WhatsApp Onboarding] Données signup stockées dans ref:",v.current)):R.event==="CANCEL"?(console.log("[WhatsApp Onboarding] Signup annulé par l'utilisateur"),v.current=null,h(!1),d({title:"Inscription annulée",description:"Vous avez fermé la fenêtre d'inscription WhatsApp.",variant:"default"})):R.event==="ERROR"&&(console.error("[WhatsApp Onboarding] Erreur:",R.data),v.current=null,h(!1)))}catch{}}};return window.addEventListener("message",i),()=>window.removeEventListener("message",i)},[d]);const I=async(i,c,y)=>{console.log("[WhatsApp Onboarding] Échange du code contre le token...");const{data:E,error:F}=await Te.functions.invoke("exchange-meta-token",{body:{code:i,waba_id:c,phone_number_id:y}});if(F)throw new Error(F.message||"Erreur lors de l'échange du token");if(!(E!=null&&E.success))throw new Error((E==null?void 0:E.error)||"Erreur inconnue");return E},k=n.useCallback(()=>new Promise(i=>{if(v.current){console.log("[WhatsApp Onboarding] Données signup déjà disponibles dans ref"),i(v.current);return}let c=0;const y=50,E=setInterval(()=>{c++,v.current?(clearInterval(E),console.log("[WhatsApp Onboarding] Données signup reçues après",c*100,"ms"),i(v.current)):c>=y&&(clearInterval(E),console.warn("[WhatsApp Onboarding] Timeout: données signup non reçues après 5s"),i(null))},100)}),[]),j=n.useCallback(async i=>{try{console.log("[WhatsApp Onboarding] Code reçu, attente des données signup...");const c=await k();if(!c||!c.waba_id||!c.phone_number_id)throw new Error("Données WhatsApp Business non reçues. Veuillez réessayer.");console.log("[WhatsApp Onboarding] Données signup reçues:",c),console.log("[WhatsApp Onboarding] Échange du code contre le token...");const y=await I(i,c.waba_id,c.phone_number_id);v.current=null,l("success"),d({title:"Connexion réussie !",description:"Votre compte WhatsApp Business est maintenant connecté."}),a==null||a({waba_id:y.waba_id,phone_number_id:y.phone_number_id,display_phone_number:y.display_phone_number,verified_name:y.verified_name})}catch(c){const y=c instanceof Error?c.message:"Une erreur est survenue";console.error("[WhatsApp Onboarding] Erreur:",c),v.current=null,l("error"),d({title:"Erreur de connexion",description:y,variant:"destructive"}),t==null||t(c instanceof Error?c:new Error(y))}finally{h(!1)}},[k,d,a,t]),L=n.useCallback(()=>{if(console.log("[WhatsApp Onboarding] Bouton cliqué, SDK chargé:",!!window.FB),!window.FB){d({title:"Erreur",description:"Le SDK Facebook n'est pas encore chargé. Réessayez.",variant:"destructive"});return}console.log("[WhatsApp Onboarding] Lancement du flux d'inscription..."),h(!0),l("idle"),v.current=null,f.current=setTimeout(()=>{h(!1),d({title:"Popup bloquée ?",description:"Vérifiez que les popups ne sont pas bloquées par votre navigateur, puis réessayez.",variant:"destructive"})},wt);const i=c=>{if(console.log("[WhatsApp Onboarding] Callback FB.login reçu:",c),f.current&&(clearTimeout(f.current),f.current=null),!c.authResponse){console.log("[WhatsApp Onboarding] Popup fermée ou accès refusé"),h(!1);return}const{code:y}=c.authResponse;if(!y){console.error("[WhatsApp Onboarding] Aucun code d'autorisation reçu"),h(!1),d({title:"Erreur",description:"Aucun code d'autorisation reçu de Facebook",variant:"destructive"});return}console.log("[WhatsApp Onboarding] Code reçu:",y.substring(0,20)+"..."),j(y)};window.FB.login(i,{config_id:U.CONFIG_ID,response_type:"code",override_default_response_type:!0,extras:{setup:{}}}),console.log("[WhatsApp Onboarding] FB.login() appelé avec config_id:",U.CONFIG_ID)},[d,j]);return e&&w==="success"?g.jsxs(me,{variant:"outline",className:"w-full",disabled:!0,children:[g.jsx(he,{className:"mr-2 h-4 w-4 text-green-500"}),"WhatsApp connecté"]}):g.jsx(me,{onClick:L,disabled:!s||p,className:"w-full",variant:w==="success"?"outline":"default",children:p?g.jsxs(g.Fragment,{children:[g.jsx(we,{className:"mr-2 h-4 w-4 animate-spin"}),"Connexion en cours..."]}):w==="success"?g.jsxs(g.Fragment,{children:[g.jsx(he,{className:"mr-2 h-4 w-4 text-green-500"}),"WhatsApp connecté"]}):w==="error"?g.jsxs(g.Fragment,{children:[g.jsx(Ue,{className:"mr-2 h-4 w-4 text-destructive"}),"Réessayer la connexion"]}):g.jsxs(g.Fragment,{children:[g.jsx(Pe,{className:"mr-2 h-4 w-4"}),s?"Connecter WhatsApp Business":"Chargement..."]})})}export{St as A,Rt as W};
