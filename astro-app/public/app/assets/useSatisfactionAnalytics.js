import{u as j}from"./useQuery.js";import{d as $,s as G}from"./index.js";import{a as X,d as Z,s as E,c as R,e as Y}from"./endOfWeek.js";import{t as z,a as I,f as N,b as P}from"./fr.js";function x(n){return z(n).getDay()}function ee(n){return z(n).getHours()}function m(n,r){return X(n,-r)}function J(n,r){return Z(n,-r)}const Q=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899","#06B6D4","#F97316","#14B8A6","#6366F1","#84CC16","#D946EF","#0EA5E9","#22C55E","#A855F7"];function ae(){var t,c;const{user:n}=$(),{data:r,isLoading:A}=j({queryKey:["revenue-orders",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return[];const{data:o,error:e}=await G.from("chatbot_orders").select("id, heure_de_commande, status, price_total, commande_item").eq("user_id",n.id).eq("status","delivered").order("heure_de_commande",{ascending:!1});if(e)throw e;return o||[]},enabled:!!(n!=null&&n.id)}),{data:h}=j({queryKey:["products-for-revenue",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return[];const{data:o,error:e}=await G.from("products").select("id, name, category, unit_price").eq("user_id",n.id);if(e)throw e;return o||[]},enabled:!!(n!=null&&n.id)}),w=new Date,M=E(w),i=R(w),g=E(m(w,1)),T=R(m(w,1)),f=(r==null?void 0:r.filter(o=>{const e=new Date(o.heure_de_commande);return e>=M&&e<=i}).reduce((o,e)=>o+(e.price_total||0),0))||0,_=(r==null?void 0:r.filter(o=>{const e=new Date(o.heure_de_commande);return e>=g&&e<=T}).reduce((o,e)=>o+(e.price_total||0),0))||0,O=_>0?Math.round((f-_)/_*100):f>0?100:0,d=[];for(let o=11;o>=0;o--){const e=I(J(w,o),{weekStartsOn:1}),s=Y(J(w,o),{weekStartsOn:1}),u=(r==null?void 0:r.filter(L=>{const y=new Date(L.heure_de_commande);return y>=e&&y<=s}))||[],l=u.reduce((L,y)=>L+(y.price_total||0),0),b=N(e,"'S'w MMM",{locale:P});d.push({week:b,revenue:Math.round(l),orders:u.length})}const q=d.length>0?Math.round(d.reduce((o,e)=>o+e.revenue,0)/d.length):0,v={};r==null||r.forEach(o=>{const e=o.commande_item;Array.isArray(e)&&e.forEach(s=>{let u=s.category;if(!u){const b=h==null?void 0:h.find(L=>L.id===s.product_id||L.name===s.name);u=b==null?void 0:b.category}if(!u)return;const l=(s.unit_price||s.price||0)*(s.quantity||1);v[u]=(v[u]||0)+l})});const p=Object.values(v).reduce((o,e)=>o+e,0)||1,S=Object.entries(v).sort((o,e)=>e[1]-o[1]).map(([o,e],s)=>({name:o,revenue:Math.round(e),percentage:Math.round(e/p*100),color:Q[s%Q.length]})),D=((t=S[0])==null?void 0:t.name)||"N/A",B=((c=S[0])==null?void 0:c.percentage)||0,k=[];for(let o=5;o>=0;o--){const e=E(m(w,o)),s=R(m(w,o)),u=E(m(w,o+1)),l=R(m(w,o+1)),b=(r==null?void 0:r.filter(H=>{const F=new Date(H.heure_de_commande);return F>=e&&F<=s}))||[],L=(r==null?void 0:r.filter(H=>{const F=new Date(H.heure_de_commande);return F>=u&&F<=l}))||[],y=b.reduce((H,F)=>H+(F.price_total||0),0),K=L.reduce((H,F)=>H+(F.price_total||0),0);let V=0;K>0?V=Math.round((y-K)/K*100):y>0&&(V=100);const U=N(e,"MMM",{locale:P});k.push({month:U,revenue:Math.round(y),growth:V})}const C=k.filter(o=>o.revenue>0),W=C.length>1?Math.round(C.slice(1).reduce((o,e)=>o+e.growth,0)/(C.length-1)):0,a=k.reduce((o,e)=>e.revenue>o.revenue?e:o,k[0]);return{orders:r,isLoading:A,revenueThisMonth:f,revenueLastMonth:_,growthPercentage:O,weeklyRevenue:d,averageWeeklyRevenue:q,revenueByCategory:S,bestCategory:D,bestCategoryPercentage:B,monthlyGrowth:k,averageGrowth:W,bestMonth:(a==null?void 0:a.month)||"N/A",bestMonthGrowth:(a==null?void 0:a.growth)||0}}function se(){const{user:n}=$(),{data:r,isLoading:A}=j({queryKey:["orders-analytics",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return[];const{data:e,error:s}=await G.from("chatbot_orders").select("id, heure_de_commande, status, price_total").eq("user_id",n.id).order("heure_de_commande",{ascending:!1});if(s)throw s;return e||[]},enabled:!!(n!=null&&n.id)}),h=new Date,w=E(h),M=R(h),i=E(m(h,1)),g=R(m(h,1)),T=(r==null?void 0:r.filter(e=>{const s=new Date(e.heure_de_commande);return s>=w&&s<=M}).length)||0,f=(r==null?void 0:r.filter(e=>{const s=new Date(e.heure_de_commande);return s>=i&&s<=g}).length)||0,_=f>0?Math.round((T-f)/f*100):0,O=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],d={0:0,1:0,2:0,3:0,4:0,5:0,6:0};r==null||r.forEach(e=>{const s=x(new Date(e.heure_de_commande));d[s]=(d[s]||0)+1});const q=(r==null?void 0:r.length)||1,v=[1,2,3,4,5,6,0].map(e=>({day:O[e],orders:d[e],percentage:Math.round(d[e]/q*100*10)/10})),p=v.reduce((e,s)=>s.orders>e.orders?s:e,v[0]),S=(p==null?void 0:p.day)||"N/A",D={};for(let e=0;e<24;e++)D[e]=0;r==null||r.forEach(e=>{const s=ee(new Date(e.heure_de_commande));D[s]=(D[s]||0)+1});const B=Object.entries(D).filter(([e])=>parseInt(e)>=11&&parseInt(e)<=23).map(([e,s])=>({hour:`${e}h`,orders:s})),k=Object.entries(D).reduce((e,s)=>s[1]>e[1]?s:e,["0",0]),C=`${k[0]}h`,W=k[1],a=(d[0]||0)+(d[6]||0),t=(d[1]||0)+(d[2]||0)+(d[3]||0)+(d[4]||0)+(d[5]||0),c=t>0?Math.round((a/2/(t/5)-1)*100):0,o=[];for(let e=7;e>=0;e--){const s=I(m(h,e*.25),{weekStartsOn:1}),u=Y(m(h,e*.25),{weekStartsOn:1}),l=(r==null?void 0:r.filter(L=>{const y=new Date(L.heure_de_commande);return y>=s&&y<=u}).length)||0,b=N(s,"'S'w MMM",{locale:P});o.push({week:b,orders:l,growth:0})}for(let e=1;e<o.length;e++){const s=o[e-1].orders,u=o[e].orders;o[e].growth=s>0?Math.round((u-s)/s*100):0}return{orders:r,isLoading:A,ordersThisMonth:T,ordersLastMonth:f,ordersGrowth:_,ordersByDayOfWeek:v,ordersByHour:B,peakDay:S,peakDayOrders:(p==null?void 0:p.orders)||0,peakHour:C,peakHourOrders:W,weekendVsWeekdayRatio:c,weeklyVolume:o,totalOrders:(r==null?void 0:r.length)||0}}function ce(){const{user:n}=$(),{data:r,isLoading:A}=j({queryKey:["customer-analytics-orders",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return[];const{data:a,error:t}=await G.from("chatbot_orders").select("id, phone, heure_de_commande, price_total, status").eq("user_id",n.id).in("status",["delivered","ready","preparing","confirmed"]);if(t)throw t;return a||[]},enabled:!!(n!=null&&n.id)}),h=new Date,w=m(h,1),M={};r==null||r.forEach(a=>{const t=a.phone;if(!t)return;const c=new Date(a.heure_de_commande),o=a.price_total||0;M[t]||(M[t]={phone:t,totalOrders:0,totalSpent:0,firstOrderDate:c,lastOrderDate:c}),M[t].totalOrders+=1,M[t].totalSpent+=o,c<M[t].firstOrderDate&&(M[t].firstOrderDate=c),c>M[t].lastOrderDate&&(M[t].lastOrderDate=c)});const i=Object.values(M),g=i.length,T=i.filter(a=>a.lastOrderDate>=w).length,f=i.filter(a=>a.totalOrders>=10),_=i.filter(a=>a.totalOrders>=3&&a.totalOrders<10),O=i.filter(a=>a.totalOrders<3),d=i.reduce((a,t)=>a+t.totalSpent,0)||1,q=[{type:"vip",count:f.length,averageSpend:f.length>0?Math.round(f.reduce((a,t)=>a+t.totalSpent,0)/f.length):0,percentageOfCustomers:Math.round(f.length/(g||1)*100),percentageOfRevenue:Math.round(f.reduce((a,t)=>a+t.totalSpent,0)/d*100)},{type:"regular",count:_.length,averageSpend:_.length>0?Math.round(_.reduce((a,t)=>a+t.totalSpent,0)/_.length):0,percentageOfCustomers:Math.round(_.length/(g||1)*100),percentageOfRevenue:Math.round(_.reduce((a,t)=>a+t.totalSpent,0)/d*100)},{type:"new",count:O.length,averageSpend:O.length>0?Math.round(O.reduce((a,t)=>a+t.totalSpent,0)/O.length):0,percentageOfCustomers:Math.round(O.length/(g||1)*100),percentageOfRevenue:Math.round(O.reduce((a,t)=>a+t.totalSpent,0)/d*100)}],v=i.filter(a=>a.totalOrders>=3).length,p=i.filter(a=>a.totalOrders>1).length,S=g>0?Math.round(p/g*100):0,D=[];for(let a=5;a>=0;a--){const t=E(m(h,a)),c=R(m(h,a)),o=i.filter(l=>l.firstOrderDate>=t&&l.firstOrderDate<=c).length,e=i.filter(l=>{const b=l.firstOrderDate<t,L=r==null?void 0:r.some(y=>{const K=new Date(y.heure_de_commande);return y.phone===l.phone&&K>=t&&K<=c});return b&&L}).length,s=i.filter(l=>l.firstOrderDate<t).length,u=s>0?Math.round(e/s*100):0;D.push({month:N(t,"MMM",{locale:P}),retention:Math.min(u,100),newCustomers:o,returningCustomers:e})}const B=E(h),k=R(h),C=i.filter(a=>a.firstOrderDate>=B&&a.firstOrderDate<=k).length,W=T>0?Math.round(C/T*100):0;return{isLoading:A,totalCustomers:g,activeCustomers:T,loyalCustomers:v,retentionRate:S,segments:q,retentionData:D,newCustomersThisMonth:C,newCustomersPercentage:W}}function de(){const{user:n}=$(),{data:r,isLoading:A}=j({queryKey:["satisfaction-reviews",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return[];const{data:t,error:c}=await G.from("order_reviews").select("id, rating, comment, created_at").eq("user_id",n.id).order("created_at",{ascending:!1});if(c)throw c;return t||[]},enabled:!!(n!=null&&n.id)}),{data:h,isLoading:w}=j({queryKey:["satisfaction-orders",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return[];const{data:t,error:c}=await G.from("chatbot_orders").select("id, review_rating, heure_de_commande").eq("user_id",n.id).not("review_rating","is",null).order("heure_de_commande",{ascending:!1});if(c)throw c;return t||[]},enabled:!!(n!=null&&n.id)}),M=A||w,i=r&&r.length>0?r.map(t=>({id:t.id,rating:t.rating,comment:t.comment,created_at:t.created_at})):(h==null?void 0:h.map(t=>({id:t.id,rating:t.review_rating,comment:null,created_at:t.heure_de_commande})))||[],g=new Date,T=E(g),f=R(g),_=E(m(g,1)),O=R(m(g,1)),d=i.length,q=i.filter(t=>t.rating!==null&&t.rating!==void 0),v=q.length>0?Math.round(q.reduce((t,c)=>t+(c.rating||0),0)/q.length*10)/10:0,p=i.filter(t=>{const c=new Date(t.created_at||"");return c>=T&&c<=f}),S=i.filter(t=>{const c=new Date(t.created_at||"");return c>=_&&c<=O}),D=p.length>0?p.reduce((t,c)=>t+(c.rating||0),0)/p.length:0,B=S.length>0?S.reduce((t,c)=>t+(c.rating||0),0)/S.length:0,k=Math.round((D-B)*10)/10,C={1:0,2:0,3:0,4:0,5:0};q.forEach(t=>{const c=Math.round(t.rating||0);c>=1&&c<=5&&C[c]++});const W=[5,4,3,2,1].map(t=>({rating:`${t} Ã©toile${t>1?"s":""}`,count:C[t],percentage:d>0?Math.round(C[t]/d*100):0})),a=[];for(let t=5;t>=0;t--){const c=E(m(g,t)),o=R(m(g,t)),e=i.filter(u=>{const l=new Date(u.created_at||"");return l>=c&&l<=o}),s=e.length>0?Math.round(e.reduce((u,l)=>u+(l.rating||0),0)/e.length*10)/10:0;a.push({month:N(c,"MMM",{locale:P}),rating:s,totalReviews:e.length})}return{isLoading:M,reviews:i,totalReviews:d,averageRating:v,ratingChange:k,ratingsDistribution:W,ratingTrend:a,reviewsThisMonth:p.length}}export{se as a,ce as b,de as c,ae as u};
